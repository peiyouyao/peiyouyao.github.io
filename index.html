<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="...">
<meta property="og:type" content="website">
<meta property="og:title" content="Perry&#39;s">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Perry&#39;s">
<meta property="og:description" content="...">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="peiyouyao">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Perry's</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Perry's</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">tech / reading / muse / painting</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/28/lang/python_coding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/28/lang/python_coding/" class="post-title-link" itemprop="url">Python Coding</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-08-28T00:00:00+01:00">2025-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/lang/" itemprop="url" rel="index"><span itemprop="name">lang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="Python-Type-Hints-Analogous-to-Java-Generics"><a href="#Python-Type-Hints-Analogous-to-Java-Generics" class="headerlink" title="Python Type Hints (Analogous to Java Generics)"></a>Python Type Hints (Analogous to Java Generics)</h1><p>Python supports <strong>type hints</strong> for static type checking (e.g., with <code>mypy</code>), which is similar to Java generics but optional and enforced only by tools, not at runtime. Python is dynamically typed, so type hints are for clarity and tooling, not compilation.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Set</span>, TypeVar, <span class="type">Generic</span></span><br><span class="line"></span><br><span class="line">T = TypeVar(<span class="string">&#x27;T&#x27;</span>)  <span class="comment"># Generic type variable, like Java&#x27;s T</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Resp</span>(<span class="type">Generic</span>[T]):  <span class="comment"># Generic class</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data: T, msg: <span class="built_in">str</span>, code: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.data: T = data</span><br><span class="line">        <span class="variable language_">self</span>.msg: <span class="built_in">str</span> = msg</span><br><span class="line">        <span class="variable language_">self</span>.code: <span class="built_in">int</span> = code</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Type Variables</strong>: Use <code>TypeVar</code> for generic types (like <code>T</code>, <code>K</code>, <code>V</code> in Java).</li>
<li><strong>No Runtime Type Erasure</strong>: Unlike Java’s generics, Python’s type hints are not erased but are ignored at runtime unless explicitly checked.</li>
<li><strong>Common Types</strong>: <code>List[T]</code>, <code>Dict[K, V]</code>, <code>Set[T]</code>, etc., from the <code>typing</code> module.</li>
</ul>
<h2 id="Generic-Functions"><a href="#Generic-Functions" class="headerlink" title="Generic Functions"></a>Generic Functions</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypeVar, <span class="type">Callable</span></span><br><span class="line"></span><br><span class="line">T = TypeVar(<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_name</span>(<span class="params">name: T</span>) -&gt; T:</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage</span></span><br><span class="line">result: <span class="built_in">str</span> = process_name(<span class="string">&quot;Mozart&quot;</span>)  <span class="comment"># Type hint ensures str</span></span><br><span class="line">result_int: <span class="built_in">int</span> = process_name(<span class="number">42</span>)    <span class="comment"># Type hint ensures int</span></span><br></pre></td></tr></table></figure>

<h1 id="Python-Built-in-Types-Analogous-to-Java-Wrapper-Classes"><a href="#Python-Built-in-Types-Analogous-to-Java-Wrapper-Classes" class="headerlink" title="Python Built-in Types (Analogous to Java Wrapper Classes)"></a>Python Built-in Types (Analogous to Java Wrapper Classes)</h1><p>Python’s basic types (<code>int</code>, <code>float</code>, <code>str</code>, <code>bool</code>) are immutable and don’t require explicit wrapper classes like Java’s <code>Integer</code> or <code>Double</code>. However, Python provides methods for type conversion.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Type conversions</span></span><br><span class="line">num_str: <span class="built_in">str</span> = <span class="string">&quot;123&quot;</span></span><br><span class="line">num_int: <span class="built_in">int</span> = <span class="built_in">int</span>(num_str)  <span class="comment"># String to int</span></span><br><span class="line">num_float: <span class="built_in">float</span> = <span class="built_in">float</span>(num_str)  <span class="comment"># String to float</span></span><br><span class="line">num_str_back: <span class="built_in">str</span> = <span class="built_in">str</span>(num_int)  <span class="comment"># Int to string</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Constants</span></span><br><span class="line">max_int: <span class="built_in">int</span> = <span class="number">2</span>**<span class="number">31</span> - <span class="number">1</span>  <span class="comment"># Similar to Integer.MAX_VALUE (for 32-bit int)</span></span><br><span class="line">min_int: <span class="built_in">int</span> = -<span class="number">2</span>**<span class="number">31</span>     <span class="comment"># Similar to Integer.MIN_VALUE</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>No Auto-Boxing&#x2F;Unboxing</strong>: Python doesn’t distinguish between primitive and wrapper types; <code>int</code> is an object with methods like <code>.__str__()</code>.</li>
<li><strong>Caching</strong>: Small integers (<code>-5</code> to <code>256</code>) and some strings are cached (similar to Java’s <code>Integer</code> cache for <code>-128</code> to <code>127</code>).</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a: <span class="built_in">int</span> = <span class="number">256</span></span><br><span class="line">b: <span class="built_in">int</span> = <span class="number">256</span></span><br><span class="line"><span class="built_in">print</span>(a <span class="keyword">is</span> b)  <span class="comment"># True (cached)</span></span><br><span class="line"></span><br><span class="line">c: <span class="built_in">int</span> = <span class="number">257</span></span><br><span class="line">d: <span class="built_in">int</span> = <span class="number">257</span></span><br><span class="line"><span class="built_in">print</span>(c <span class="keyword">is</span> d)  <span class="comment"># False (not cached)</span></span><br></pre></td></tr></table></figure>

<h1 id="Python-Lists-Analogous-to-Java-Arrays-and-ArrayList"><a href="#Python-Lists-Analogous-to-Java-Arrays-and-ArrayList" class="headerlink" title="Python Lists (Analogous to Java Arrays and ArrayList)"></a>Python Lists (Analogous to Java Arrays and ArrayList)</h1><p>Python’s <code>list</code> is a dynamic array, similar to Java’s <code>ArrayList</code>. It’s mutable, resizable, and supports random access.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize list</span></span><br><span class="line">notes: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;C&quot;</span>, <span class="string">&quot;C#&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;D#&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;F&quot;</span>, <span class="string">&quot;F#&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;G#&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;A#&quot;</span>, <span class="string">&quot;B&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Basic operations</span></span><br><span class="line">notes.append(<span class="string">&quot;C&quot;</span>)          <span class="comment"># Add element (O(1) amortized)</span></span><br><span class="line">notes.insert(<span class="number">1</span>, <span class="string">&quot;Db&quot;</span>)      <span class="comment"># Insert at index (O(n))</span></span><br><span class="line">notes.pop()                <span class="comment"># Remove last (O(1))</span></span><br><span class="line">notes.pop(<span class="number">0</span>)               <span class="comment"># Remove at index (O(n))</span></span><br><span class="line">notes[<span class="number">2</span>] = <span class="string">&quot;D2&quot;</span>            <span class="comment"># Update element (O(1))</span></span><br><span class="line"><span class="built_in">print</span>(notes[<span class="number">0</span>])            <span class="comment"># Access element (O(1))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Slicing (similar to Java&#x27;s subList)</span></span><br><span class="line">subset: <span class="type">List</span>[<span class="built_in">str</span>] = notes[<span class="number">1</span>:<span class="number">4</span>]  <span class="comment"># Returns [&quot;Db&quot;, &quot;D2&quot;, &quot;D#&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List comprehension (similar to Java Stream)</span></span><br><span class="line">evens: <span class="type">List</span>[<span class="built_in">int</span>] = [x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>]  <span class="comment"># [0, 2, 4, 6, 8]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Performance</strong>: <ul>
<li>Access&#x2F;Modify: O(1)</li>
<li>Insert&#x2F;Delete (non-end): O(n)</li>
<li>Append&#x2F;Pop (end): O(1) amortized</li>
</ul>
</li>
<li><strong>Thread Safety</strong>: Python lists are not thread-safe (use <code>threading.Lock</code> if needed).</li>
<li><strong>Immutable Alternative</strong>: Use <code>tuple</code> for immutable sequences.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tuple (immutable)</span></span><br><span class="line">notes_tuple: <span class="built_in">tuple</span> = (<span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>)</span><br><span class="line"><span class="comment"># notes_tuple[0] = &quot;F&quot;  # Error: tuples are immutable</span></span><br></pre></td></tr></table></figure>

<h1 id="Python-Sets-Analogous-to-Java-Set"><a href="#Python-Sets-Analogous-to-Java-Set" class="headerlink" title="Python Sets (Analogous to Java Set)"></a>Python Sets (Analogous to Java Set)</h1><p>Python’s <code>set</code> is similar to Java’s <code>HashSet</code>, providing O(1) average-case operations for add, remove, and lookup. Python lacks direct equivalents to <code>LinkedHashSet</code> and <code>TreeSet</code>, but alternatives exist.</p>
<h2 id="set-Analogous-to-HashSet"><a href="#set-Analogous-to-HashSet" class="headerlink" title="set (Analogous to HashSet)"></a><code>set</code> (Analogous to HashSet)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize set</span></span><br><span class="line">unique_notes: <span class="type">Set</span>[<span class="built_in">str</span>] = &#123;<span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>&#125;</span><br><span class="line">unique_notes.add(<span class="string">&quot;F&quot;</span>)           <span class="comment"># Add element (O(1) average)</span></span><br><span class="line">unique_notes.remove(<span class="string">&quot;C&quot;</span>)        <span class="comment"># Remove element (O(1) average, raises KeyError if not found)</span></span><br><span class="line">unique_notes.discard(<span class="string">&quot;D&quot;</span>)       <span class="comment"># Remove if present (O(1) average, no error)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;E&quot;</span> <span class="keyword">in</span> unique_notes)      <span class="comment"># Check containment (O(1) average)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set operations</span></span><br><span class="line">set1: <span class="type">Set</span>[<span class="built_in">int</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">set2: <span class="type">Set</span>[<span class="built_in">int</span>] = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(set1 | set2)  <span class="comment"># Union: &#123;1, 2, 3, 4&#125;</span></span><br><span class="line"><span class="built_in">print</span>(set1 &amp; set2)  <span class="comment"># Intersection: &#123;2, 3&#125;</span></span><br><span class="line"><span class="built_in">print</span>(set1 - set2)  <span class="comment"># Difference: &#123;1&#125;</span></span><br><span class="line"><span class="built_in">print</span>(set1 ^ set2)  <span class="comment"># Symmetric difference: &#123;1, 4&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Custom Objects</strong>: Must implement <code>__hash__</code> and <code>__eq__</code> for use in sets (similar to Java’s <code>hashCode</code> and <code>equals</code>).</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">id</span>: <span class="built_in">int</span>, username: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.<span class="built_in">id</span>: <span class="built_in">int</span> = <span class="built_in">id</span></span><br><span class="line">        <span class="variable language_">self</span>.username: <span class="built_in">str</span> = username</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>((<span class="variable language_">self</span>.<span class="built_in">id</span>, <span class="variable language_">self</span>.username))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, User):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.<span class="built_in">id</span> == other.<span class="built_in">id</span> <span class="keyword">and</span> <span class="variable language_">self</span>.username == other.username</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">users: <span class="type">Set</span>[User] = &#123;User(<span class="number">1</span>, <span class="string">&quot;Bach&quot;</span>), User(<span class="number">2</span>, <span class="string">&quot;Beethoven&quot;</span>)&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Ordered-Set-Analogous-to-LinkedHashSet"><a href="#Ordered-Set-Analogous-to-LinkedHashSet" class="headerlink" title="Ordered Set (Analogous to LinkedHashSet)"></a>Ordered Set (Analogous to LinkedHashSet)</h2><p>Python’s standard library doesn’t have a <code>LinkedHashSet</code> equivalent, but <code>collections.OrderedDict</code> (since Python 3.7, regular <code>dict</code> preserves insertion order) or third-party libraries like <code>ordered-set</code> can mimic it.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using OrderedDict as an ordered set</span></span><br><span class="line">ordered_set = OrderedDict.fromkeys([<span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>])  <span class="comment"># Keys maintain insertion order</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(ordered_set.keys()))  <span class="comment"># [&quot;C&quot;, &quot;D&quot;, &quot;E&quot;]</span></span><br></pre></td></tr></table></figure>

<h2 id="Sorted-Set-Analogous-to-TreeSet"><a href="#Sorted-Set-Analogous-to-TreeSet" class="headerlink" title="Sorted Set (Analogous to TreeSet)"></a>Sorted Set (Analogous to TreeSet)</h2><p>Python lacks a built-in <code>TreeSet</code>, but you can use <code>sortedcontainers.SortedSet</code> (third-party) or maintain a sorted list with <code>bisect</code> for sorted operations.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sortedcontainers <span class="keyword">import</span> SortedSet</span><br><span class="line"></span><br><span class="line">sorted_set: SortedSet = SortedSet([<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(sorted_set)  <span class="comment"># SortedSet([1, 2, 3])</span></span><br><span class="line">sorted_set.add(<span class="number">4</span>)  <span class="comment"># O(log n)</span></span><br><span class="line"><span class="built_in">print</span>(sorted_set[<span class="number">0</span>])  <span class="comment"># 1 (smallest, O(1))</span></span><br><span class="line"><span class="built_in">print</span>(sorted_set[-<span class="number">1</span>])  <span class="comment"># 4 (largest, O(1))</span></span><br><span class="line"><span class="built_in">print</span>(sorted_set.bisect_left(<span class="number">2</span>))  <span class="comment"># Index where 2 would be inserted (O(log n))</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Alternative with <code>bisect</code></strong>:<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bisect</span><br><span class="line"></span><br><span class="line">sorted_list: <span class="type">List</span>[<span class="built_in">int</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">bisect.insort(sorted_list, <span class="number">2</span>)  <span class="comment"># Inserts 2 in sorted order (O(n) for insert, O(log n) for search)</span></span><br><span class="line"><span class="built_in">print</span>(sorted_list)  <span class="comment"># [1, 2, 2, 3]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Python-Dictionaries-Analogous-to-Java-Map"><a href="#Python-Dictionaries-Analogous-to-Java-Map" class="headerlink" title="Python Dictionaries (Analogous to Java Map)"></a>Python Dictionaries (Analogous to Java Map)</h1><p>Python’s <code>dict</code> is similar to Java’s <code>HashMap</code>, with O(1) average-case operations. Since Python 3.7, <code>dict</code> preserves insertion order (like <code>LinkedHashMap</code>).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize dictionary</span></span><br><span class="line">composer_scores: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>] = &#123;<span class="string">&quot;Bach&quot;</span>: <span class="number">95</span>, <span class="string">&quot;Beethoven&quot;</span>: <span class="number">90</span>, <span class="string">&quot;Mozart&quot;</span>: <span class="number">85</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Basic operations</span></span><br><span class="line">composer_scores[<span class="string">&quot;Schubert&quot;</span>] = <span class="number">88</span>  <span class="comment"># Add/Update (O(1) average)</span></span><br><span class="line"><span class="keyword">del</span> composer_scores[<span class="string">&quot;Bach&quot;</span>]       <span class="comment"># Remove (O(1) average)</span></span><br><span class="line"><span class="built_in">print</span>(composer_scores.get(<span class="string">&quot;Mozart&quot;</span>, <span class="number">0</span>))  <span class="comment"># Get with default (O(1) average)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Beethoven&quot;</span> <span class="keyword">in</span> composer_scores)    <span class="comment"># Check key (O(1) average)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Iteration</span></span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> composer_scores:  <span class="comment"># Iterate keys</span></span><br><span class="line">    <span class="built_in">print</span>(key)</span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> composer_scores.values():  <span class="comment"># Iterate values</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> composer_scores.items():  <span class="comment"># Iterate key-value pairs</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dictionary comprehension</span></span><br><span class="line">squares: <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">int</span>] = &#123;x: x*x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)&#125;  <span class="comment"># &#123;0: 0, 1: 1, 2: 4, 3: 9, 4: 16&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Sorted Dictionary (Analogous to TreeMap)</strong>: Use <code>sortedcontainers.SortedDict</code> for sorted keys.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sortedcontainers <span class="keyword">import</span> SortedDict</span><br><span class="line"></span><br><span class="line">sorted_dict = SortedDict(&#123;<span class="string">&quot;C&quot;</span>: <span class="number">1</span>, <span class="string">&quot;A&quot;</span>: <span class="number">2</span>, <span class="string">&quot;B&quot;</span>: <span class="number">3</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(sorted_dict)  <span class="comment"># SortedDict(&#123;&#x27;A&#x27;: 2, &#x27;B&#x27;: 3, &#x27;C&#x27;: 1&#125;)</span></span><br><span class="line"><span class="built_in">print</span>(sorted_dict.peekitem(<span class="number">0</span>))  <span class="comment"># (&#x27;A&#x27;, 2) - smallest key</span></span><br></pre></td></tr></table></figure>

<h1 id="Python-Deques-Analogous-to-Java-Deque"><a href="#Python-Deques-Analogous-to-Java-Deque" class="headerlink" title="Python Deques (Analogous to Java Deque)"></a>Python Deques (Analogous to Java Deque)</h1><p>Python’s <code>collections.deque</code> is a double-ended queue, similar to Java’s <code>ArrayDeque</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line">dq: deque = deque([<span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>])</span><br><span class="line">dq.append(<span class="string">&quot;F&quot;</span>)        <span class="comment"># Add to right (O(1))</span></span><br><span class="line">dq.appendleft(<span class="string">&quot;B&quot;</span>)    <span class="comment"># Add to left (O(1))</span></span><br><span class="line">dq.pop()              <span class="comment"># Remove from right (O(1))</span></span><br><span class="line">dq.popleft()          <span class="comment"># Remove from left (O(1))</span></span><br><span class="line"><span class="built_in">print</span>(dq[<span class="number">0</span>])          <span class="comment"># Access first (O(1))</span></span><br><span class="line"><span class="built_in">print</span>(dq[-<span class="number">1</span>])         <span class="comment"># Access last (O(1))</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Use Case</strong>: Efficient for stacks&#x2F;queues in problems (e.g., sliding window, BFS).</li>
</ul>
<h1 id="Python-Heaps-Analogous-to-Java-PriorityQueue"><a href="#Python-Heaps-Analogous-to-Java-PriorityQueue" class="headerlink" title="Python Heaps (Analogous to Java PriorityQueue)"></a>Python Heaps (Analogous to Java PriorityQueue)</h1><p>Python’s <code>heapq</code> module provides a min-heap, similar to Java’s <code>PriorityQueue</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> heapq</span><br><span class="line"></span><br><span class="line">heap: <span class="type">List</span>[<span class="built_in">int</span>] = [<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">heapq.heapify(heap)  <span class="comment"># O(n)</span></span><br><span class="line">heapq.heappush(heap, <span class="number">4</span>)  <span class="comment"># O(log n)</span></span><br><span class="line"><span class="built_in">print</span>(heapq.heappop(heap))  <span class="comment"># 1 (O(log n))</span></span><br><span class="line"><span class="built_in">print</span>(heap[<span class="number">0</span>])  <span class="comment"># Peek smallest (O(1))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Max-heap (negate values)</span></span><br><span class="line">max_heap: <span class="type">List</span>[<span class="built_in">int</span>] = [-x <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>]]</span><br><span class="line">heapq.heapify(max_heap)</span><br><span class="line"><span class="built_in">print</span>(-heapq.heappop(max_heap))  <span class="comment"># 3</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Custom Objects</strong>: Use tuples with priority or define <code>__lt__</code> for custom types.</li>
</ul>
<h1 id="List-to-Set-Dict-and-Vice-Versa"><a href="#List-to-Set-Dict-and-Vice-Versa" class="headerlink" title="List to Set&#x2F;Dict and Vice Versa"></a>List to Set&#x2F;Dict and Vice Versa</h1><h2 id="List-to-Set-Dict"><a href="#List-to-Set-Dict" class="headerlink" title="List to Set&#x2F;Dict"></a>List to Set&#x2F;Dict</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">notes: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;E&quot;</span>]</span><br><span class="line">unique_notes: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>(notes)  <span class="comment"># &#123;&quot;C&quot;, &quot;D&quot;, &quot;E&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List to dict</span></span><br><span class="line">pairs: <span class="type">List</span>[<span class="built_in">tuple</span>[<span class="built_in">str</span>, <span class="built_in">int</span>]] = [(<span class="string">&quot;Bach&quot;</span>, <span class="number">95</span>), (<span class="string">&quot;Beethoven&quot;</span>, <span class="number">90</span>)]</span><br><span class="line">composer_scores: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>] = <span class="built_in">dict</span>(pairs)  <span class="comment"># &#123;&quot;Bach&quot;: 95, &quot;Beethoven&quot;: 90&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Set-Dict-to-List"><a href="#Set-Dict-to-List" class="headerlink" title="Set&#x2F;Dict to List"></a>Set&#x2F;Dict to List</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">unique_notes: <span class="type">Set</span>[<span class="built_in">str</span>] = &#123;<span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>&#125;</span><br><span class="line">notes_list: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="built_in">list</span>(unique_notes)  <span class="comment"># [&quot;C&quot;, &quot;D&quot;, &quot;E&quot;]</span></span><br><span class="line"></span><br><span class="line">composer_scores: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>] = &#123;<span class="string">&quot;Bach&quot;</span>: <span class="number">95</span>, <span class="string">&quot;Beethoven&quot;</span>: <span class="number">90</span>&#125;</span><br><span class="line">keys: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="built_in">list</span>(composer_scores.keys())  <span class="comment"># [&quot;Bach&quot;, &quot;Beethoven&quot;]</span></span><br><span class="line">values: <span class="type">List</span>[<span class="built_in">int</span>] = <span class="built_in">list</span>(composer_scores.values())  <span class="comment"># [95, 90]</span></span><br><span class="line">items: <span class="type">List</span>[<span class="built_in">tuple</span>[<span class="built_in">str</span>, <span class="built_in">int</span>]] = <span class="built_in">list</span>(composer_scores.items())  <span class="comment"># [(&quot;Bach&quot;, 95), (&quot;Beethoven&quot;, 90)]</span></span><br></pre></td></tr></table></figure>

<h1 id="Sorting-in-Python"><a href="#Sorting-in-Python" class="headerlink" title="Sorting in Python"></a>Sorting in Python</h1><p>Python’s <code>sorted()</code> and <code>list.sort()</code> are analogous to Java’s <code>Collections.sort</code> and <code>Arrays.sort</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default sorting</span></span><br><span class="line">notes: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;Beethoven&quot;</span>, <span class="string">&quot;Bach&quot;</span>, <span class="string">&quot;Mozart&quot;</span>]</span><br><span class="line">sorted_notes: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="built_in">sorted</span>(notes)  <span class="comment"># New sorted list</span></span><br><span class="line">notes.sort()  <span class="comment"># In-place sort</span></span><br><span class="line"><span class="built_in">print</span>(sorted_notes)  <span class="comment"># [&quot;Bach&quot;, &quot;Beethoven&quot;, &quot;Mozart&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Custom sorting with key function</span></span><br><span class="line">sorted_by_length: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="built_in">sorted</span>(notes, key=<span class="built_in">len</span>)  <span class="comment"># Sort by length</span></span><br><span class="line"><span class="built_in">print</span>(sorted_by_length)  <span class="comment"># [&quot;Bach&quot;, &quot;Mozart&quot;, &quot;Beethoven&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reverse sorting</span></span><br><span class="line">sorted_reverse: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="built_in">sorted</span>(notes, reverse=<span class="literal">True</span>)  <span class="comment"># [&quot;Mozart&quot;, &quot;Beethoven&quot;, &quot;Bach&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Custom key function with multiple criteria</span></span><br><span class="line">users: <span class="type">List</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">str</span>]] = [(<span class="number">1</span>, <span class="string">&quot;Bach&quot;</span>), (<span class="number">2</span>, <span class="string">&quot;Beethoven&quot;</span>), (<span class="number">1</span>, <span class="string">&quot;Mozart&quot;</span>)]</span><br><span class="line">sorted_users: <span class="type">List</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">str</span>]] = <span class="built_in">sorted</span>(users, key=<span class="keyword">lambda</span> x: (x[<span class="number">0</span>], x[<span class="number">1</span>]))</span><br><span class="line"><span class="built_in">print</span>(sorted_users)  <span class="comment"># [(1, &quot;Bach&quot;), (1, &quot;Mozart&quot;), (2, &quot;Beethoven&quot;)]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Note</strong>: <code>sorted()</code> works on any iterable and returns a list; <code>list.sort()</code> is in-place and only for lists. For primitive-like lists (e.g., <code>int</code>), no boxing is needed, unlike Java.</li>
</ul>
<h1 id="Stream-like-Operations-in-Python"><a href="#Stream-like-Operations-in-Python" class="headerlink" title="Stream-like Operations in Python"></a>Stream-like Operations in Python</h1><p>Python doesn’t have a direct <code>Stream</code> API, but list comprehensions, generators, and <code>itertools</code> provide similar functionality for functional-style processing.</p>
<h2 id="Creating-Streams-Iterables"><a href="#Creating-Streams-Iterables" class="headerlink" title="Creating Streams (Iterables)"></a>Creating Streams (Iterables)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line"><span class="comment"># From list</span></span><br><span class="line">lst: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;Bach&quot;</span>, <span class="string">&quot;Beethoven&quot;</span>, <span class="string">&quot;Mozart&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> composer <span class="keyword">in</span> lst:</span><br><span class="line">    <span class="built_in">print</span>(composer)</span><br><span class="line"></span><br><span class="line"><span class="comment"># From dictionary</span></span><br><span class="line">composer_scores: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>] = &#123;<span class="string">&quot;Bach&quot;</span>: <span class="number">95</span>, <span class="string">&quot;Beethoven&quot;</span>: <span class="number">90</span>&#125;</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> composer_scores.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># From array-like data</span></span><br><span class="line">nums: <span class="type">List</span>[<span class="built_in">int</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> nums:</span><br><span class="line">    <span class="built_in">print</span>(num)</span><br><span class="line"></span><br><span class="line"><span class="comment"># From arbitrary data</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]:</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br></pre></td></tr></table></figure>

<h2 id="Intermediate-Operations"><a href="#Intermediate-Operations" class="headerlink" title="Intermediate Operations"></a>Intermediate Operations</h2><h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lst: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;EEFG&quot;</span>, <span class="string">&quot;GFED&quot;</span>, <span class="string">&quot;CCDE&quot;</span>, <span class="string">&quot;EDD-&quot;</span>]</span><br><span class="line">filtered: <span class="type">List</span>[<span class="built_in">str</span>] = [s <span class="keyword">for</span> s <span class="keyword">in</span> lst <span class="keyword">if</span> <span class="keyword">not</span> s.endswith(<span class="string">&quot;-&quot;</span>)]  <span class="comment"># [&quot;EEFG&quot;, &quot;GFED&quot;, &quot;CCDE&quot;]</span></span><br><span class="line"><span class="comment"># Or using filter()</span></span><br><span class="line">filtered_alt: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> s: <span class="keyword">not</span> s.endswith(<span class="string">&quot;-&quot;</span>), lst))</span><br></pre></td></tr></table></figure>

<h3 id="Limit-Skip-Distinct"><a href="#Limit-Skip-Distinct" class="headerlink" title="Limit&#x2F;Skip&#x2F;Distinct"></a>Limit&#x2F;Skip&#x2F;Distinct</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nums: <span class="type">List</span>[<span class="built_in">int</span>] = [<span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>]</span><br><span class="line">limited: <span class="type">List</span>[<span class="built_in">int</span>] = nums[:<span class="number">3</span>]  <span class="comment"># First 3: [3, 3, 4]</span></span><br><span class="line">skipped: <span class="type">List</span>[<span class="built_in">int</span>] = nums[<span class="number">3</span>:]  <span class="comment"># Skip first 3: [5, 5, 4, 3]</span></span><br><span class="line">distinct: <span class="type">List</span>[<span class="built_in">int</span>] = <span class="built_in">list</span>(<span class="built_in">set</span>(nums))  <span class="comment"># [3, 4, 5] (order not preserved)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Using itertools for distinct with order preservation</span></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> groupby</span><br><span class="line">sorted_nums = <span class="built_in">sorted</span>(nums)</span><br><span class="line">distinct_ordered: <span class="type">List</span>[<span class="built_in">int</span>] = [k <span class="keyword">for</span> k, _ <span class="keyword">in</span> groupby(sorted_nums)]  <span class="comment"># [3, 4, 5]</span></span><br></pre></td></tr></table></figure>

<h3 id="Concat"><a href="#Concat" class="headerlink" title="Concat"></a>Concat</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">lst1: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;EEFG&quot;</span>, <span class="string">&quot;GFED&quot;</span>]</span><br><span class="line">lst2: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;GCDEF&quot;</span>, <span class="string">&quot;GCC&quot;</span>]</span><br><span class="line">concatenated: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="built_in">list</span>(chain(lst1, lst2))  <span class="comment"># [&quot;EEFG&quot;, &quot;GFED&quot;, &quot;GCDEF&quot;, &quot;GCC&quot;]</span></span><br></pre></td></tr></table></figure>

<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lst: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;C-1&quot;</span>, <span class="string">&quot;D-2&quot;</span>, <span class="string">&quot;E-3&quot;</span>]</span><br><span class="line">values: <span class="type">List</span>[<span class="built_in">int</span>] = [<span class="built_in">int</span>(s.split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>]) <span class="keyword">for</span> s <span class="keyword">in</span> lst]  <span class="comment"># [1, 2, 3]</span></span><br><span class="line"><span class="comment"># Or using map()</span></span><br><span class="line">values_alt: <span class="type">List</span>[<span class="built_in">int</span>] = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> s: <span class="built_in">int</span>(s.split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>]), lst))</span><br></pre></td></tr></table></figure>

<h2 id="Terminal-Operations"><a href="#Terminal-Operations" class="headerlink" title="Terminal Operations"></a>Terminal Operations</h2><h3 id="ForEach"><a href="#ForEach" class="headerlink" title="ForEach"></a>ForEach</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lst: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;Bach&quot;</span>, <span class="string">&quot;Beethoven&quot;</span>, <span class="string">&quot;Mozart&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> lst:</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line"><span class="comment"># Or</span></span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">print</span>, lst))  <span class="comment"># Less common, but functional style</span></span><br></pre></td></tr></table></figure>

<h3 id="Count"><a href="#Count" class="headerlink" title="Count"></a>Count</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lst: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;EEFG&quot;</span>, <span class="string">&quot;GFED&quot;</span>, <span class="string">&quot;CCDE&quot;</span>, <span class="string">&quot;EDD-&quot;</span>]</span><br><span class="line">count: <span class="built_in">int</span> = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> s <span class="keyword">in</span> lst <span class="keyword">if</span> s.startswith(<span class="string">&quot;G&quot;</span>) <span class="keyword">or</span> s.startswith(<span class="string">&quot;C&quot;</span>))  <span class="comment"># 3</span></span><br><span class="line"><span class="comment"># Or using len</span></span><br><span class="line">count_alt: <span class="built_in">int</span> = <span class="built_in">len</span>([s <span class="keyword">for</span> s <span class="keyword">in</span> lst <span class="keyword">if</span> s.startswith(<span class="string">&quot;G&quot;</span>) <span class="keyword">or</span> s.startswith(<span class="string">&quot;C&quot;</span>)])</span><br></pre></td></tr></table></figure>

<h3 id="Collect-to-List-Set-Dict"><a href="#Collect-to-List-Set-Dict" class="headerlink" title="Collect to List&#x2F;Set&#x2F;Dict"></a>Collect to List&#x2F;Set&#x2F;Dict</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">lst: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;Bach-17&quot;</span>, <span class="string">&quot;Beethoven-19&quot;</span>, <span class="string">&quot;Mozart-18&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># To list</span></span><br><span class="line">b_list: <span class="type">List</span>[<span class="built_in">str</span>] = [s <span class="keyword">for</span> s <span class="keyword">in</span> lst <span class="keyword">if</span> s.startswith(<span class="string">&quot;B&quot;</span>)]  <span class="comment"># [&quot;Bach-17&quot;, &quot;Beethoven-19&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To set</span></span><br><span class="line">b_set: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>(s <span class="keyword">for</span> s <span class="keyword">in</span> lst <span class="keyword">if</span> s.startswith(<span class="string">&quot;B&quot;</span>))  <span class="comment"># &#123;&quot;Bach-17&quot;, &quot;Beethoven-19&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To dict</span></span><br><span class="line">b_map: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>] = &#123;s.split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>]: <span class="built_in">int</span>(s.split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>]) <span class="keyword">for</span> s <span class="keyword">in</span> lst <span class="keyword">if</span> s.startswith(<span class="string">&quot;B&quot;</span>)&#125;</span><br><span class="line"><span class="built_in">print</span>(b_map)  <span class="comment"># &#123;&quot;Bach&quot;: 17, &quot;Beethoven&quot;: 19&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Join-to-String"><a href="#Join-to-String" class="headerlink" title="Join to String"></a>Join to String</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">words: <span class="type">List</span>[<span class="built_in">str</span>] = [<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;world&quot;</span>, <span class="string">&quot;this&quot;</span>, <span class="string">&quot;is&quot;</span>, <span class="string">&quot;Python&quot;</span>]</span><br><span class="line">result: <span class="built_in">str</span> = <span class="string">&quot; &quot;</span>.join(words)  <span class="comment"># &quot;Hello world this is Python&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Generators-for-Lazy-Evaluation"><a href="#Generators-for-Lazy-Evaluation" class="headerlink" title="Generators for Lazy Evaluation"></a>Generators for Lazy Evaluation</h2><p>For memory-efficient stream-like processing, use generators:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">large_range</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">evens = (x <span class="keyword">for</span> x <span class="keyword">in</span> large_range() <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>)  <span class="comment"># Lazy evaluation</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(evens))  <span class="comment"># 0 (processes one element at a time)</span></span><br></pre></td></tr></table></figure>

<h1 id="Strings-and-Related"><a href="#Strings-and-Related" class="headerlink" title="Strings and Related"></a>Strings and Related</h1><ul>
<li><strong>String</strong>: Immutable (<code>str</code>).</li>
<li><strong>Mutable Alternatives</strong>: Use <code>list</code> of characters or <code>io.StringIO</code> for efficient string building.</li>
<li><strong>Thread Safety</strong>: Strings and lists are not thread-safe; use <code>threading.Lock</code> if needed.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s: <span class="built_in">str</span> = <span class="string">&quot;Hello&quot;</span></span><br><span class="line"><span class="comment"># s[0] = &quot;h&quot;  # Error: str is immutable</span></span><br><span class="line">chars: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="built_in">list</span>(s)  <span class="comment"># [&quot;H&quot;, &quot;e&quot;, &quot;l&quot;, &quot;l&quot;, &quot;o&quot;]</span></span><br><span class="line">chars[<span class="number">0</span>] = <span class="string">&quot;h&quot;</span></span><br><span class="line">new_s: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>.join(chars)  <span class="comment"># &quot;hello&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="2D-Lists-Analogous-to-Java-2D-Arrays"><a href="#2D-Lists-Analogous-to-Java-2D-Arrays" class="headerlink" title="2D Lists (Analogous to Java 2D Arrays)"></a>2D Lists (Analogous to Java 2D Arrays)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize jagged 2D list</span></span><br><span class="line">arr: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]] = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">arr[<span class="number">0</span>] = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">arr[<span class="number">1</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">arr[<span class="number">2</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span>(arr)  <span class="comment"># [[1, 2], [1, 2, 3], [1, 2, 3, 4]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Fixed-size 2D list</span></span><br><span class="line">rows, cols = <span class="number">3</span>, <span class="number">4</span></span><br><span class="line">matrix: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]] = [[<span class="number">0</span>] * cols <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(rows)]</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Note</strong>: Avoid <code>[[0] * cols] * rows</code> as it creates shared references to the same inner list.</li>
</ul>
<h1 id="Summary-for-Problem-Solving"><a href="#Summary-for-Problem-Solving" class="headerlink" title="Summary for Problem-Solving"></a>Summary for Problem-Solving</h1><ul>
<li><strong>List</strong>: Use for dynamic arrays, stacks, or queues (O(1) append&#x2F;pop).</li>
<li><strong>Set</strong>: Use for O(1) lookups and uniqueness (e.g., deduplication in problems).</li>
<li><strong>Dict</strong>: Use for key-value mappings, frequency counting, or graph adjacency lists.</li>
<li><strong>Deque</strong>: Use for sliding windows, BFS, or double-ended operations.</li>
<li><strong>Heapq</strong>: Use for priority queues (e.g., top-k problems, Dijkstra’s algorithm).</li>
<li><strong>SortedSet&#x2F;SortedDict</strong>: Use for sorted data (install <code>sortedcontainers</code>).</li>
<li><strong>Stream-like</strong>: Use list comprehensions or generators for concise, functional-style coding.</li>
<li><strong>Sorting</strong>: Use <code>sorted()</code> or <code>list.sort()</code> with <code>key</code> for custom sorting.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/23/tech/rabbitmq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/23/tech/rabbitmq/" class="post-title-link" itemprop="url">Rabbit MQ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-23 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-23T00:00:00+01:00">2025-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/20/tech/apidoc_in_microservice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/20/tech/apidoc_in_microservice/" class="post-title-link" itemprop="url">Api Doc in Microservice Project</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-05-20 00:00:00" itemprop="dateCreated datePublished" datetime="2025-05-20T00:00:00+01:00">2025-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>微服务文档聚合配置模板（基于 Spring Boot 2.7.6 + Spring Cloud Gateway + Knife4j 4.3.0 + Nacos）</strong>：</p>
<hr>
<h2 id="🧱-1-父项目-pom-xml-中版本管理"><a href="#🧱-1-父项目-pom-xml-中版本管理" class="headerlink" title="🧱 1. 父项目 pom.xml 中版本管理"></a>🧱 1. 父项目 <code>pom.xml</code> 中版本管理</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.7.6<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>2021.0.6<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">knife4j.version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">knife4j.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-gateway-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;knife4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🚪-2-Gateway-项目依赖"><a href="#🚪-2-Gateway-项目依赖" class="headerlink" title="🚪 2. Gateway 项目依赖"></a>🚪 2. Gateway 项目依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-gateway-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="⚙️-3-Gateway-application-yml-配置（核心）"><a href="#⚙️-3-Gateway-application-yml-配置（核心）" class="headerlink" title="⚙️ 3. Gateway application.yml 配置（核心）"></a>⚙️ 3. Gateway <code>application.yml</code> 配置（核心）</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pyoj-backend-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">pyoj-backend-user-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pyoj-backend-user-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/user/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">pyoj-backend-question-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pyoj-backend-question-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/question/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">pyoj-backend-submit-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pyoj-backend-submit-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/submit/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">pyoj-backend-judge-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pyoj-backend-judge-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/judge/**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">strategy:</span> <span class="string">manual</span></span><br><span class="line">    <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">用户服务</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">pyoj-backend-user-service</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">/api/user/v3/api-docs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">题目服务</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">pyoj-backend-question-service</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">/api/question/v3/api-docs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">提交服务</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">pyoj-backend-submit-service</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">/api/submit/v3/api-docs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">判题服务</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">pyoj-backend-judge-service</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">/api/judge/v3/api-docs</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📦-4-子服务通用依赖（user-question-submit-judge）"><a href="#📦-4-子服务通用依赖（user-question-submit-judge）" class="headerlink" title="📦 4. 子服务通用依赖（user &#x2F; question &#x2F; submit &#x2F; judge）"></a>📦 4. 子服务通用依赖（user &#x2F; question &#x2F; submit &#x2F; judge）</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- OpenAPI 文档生成 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springdoc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springdoc-openapi-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Knife4j 增强支持（可选） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-openapi3-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📝-5-子服务通用配置（application-yml）"><a href="#📝-5-子服务通用配置（application-yml）" class="headerlink" title="📝 5. 子服务通用配置（application.yml）"></a>📝 5. 子服务通用配置（application.yml）</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">springdoc:</span></span><br><span class="line">  <span class="attr">api-docs:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">swagger-ui:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 若需要 context-path，需配合 gateway 路由写好前缀</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/api/user</span>  <span class="comment"># 不同服务改不同前缀</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📍-6-访问地址"><a href="#📍-6-访问地址" class="headerlink" title="📍 6. 访问地址"></a>📍 6. 访问地址</h2><ul>
<li><p>聚合入口（统一访问）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/knife4j</span><br></pre></td></tr></table></figure>
</li>
<li><p>单服务 Swagger UI：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8081/api/user/swagger-ui/index.html # openapi</span><br><span class="line">http://localhost:8081/api/user/doc.html  # Knife4j UI</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="✅-附：快速排错建议"><a href="#✅-附：快速排错建议" class="headerlink" title="✅ 附：快速排错建议"></a>✅ 附：快速排错建议</h2><table>
<thead>
<tr>
<th>问题</th>
<th>原因</th>
<th>解决</th>
</tr>
</thead>
<tbody><tr>
<td>文档请求异常</td>
<td>gateway 未配置 route</td>
<td>补上该服务的 route</td>
</tr>
<tr>
<td>聚合失败</td>
<td>manual 模式未写正确 url</td>
<td>补 <code>/api/**/v3/api-docs</code> 路径</td>
</tr>
<tr>
<td>Knife4j 页面白屏</td>
<td>controller 参数未加注解 &#x2F; path 错误</td>
<td>加 <code>@RequestParam</code>, 避免 <code>@RequestMapping(&quot;&quot;)</code></td>
</tr>
<tr>
<td>无法识别接口</td>
<td>没加 <code>springdoc-openapi-ui</code></td>
<td>所有服务都要加 openapi 依赖</td>
</tr>
</tbody></table>
<p><strong>注</strong>: 对于内部api(XXXInnerController), 可以打上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@io.swagger.v3.oas.annotations.Hidden</span><br></pre></td></tr></table></figure>

<p>注解, 使其不暴露在接口文档中. </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/23/tech/wsl2_clash_proxy_docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/23/tech/wsl2_clash_proxy_docker/" class="post-title-link" itemprop="url">Clash in Win, proxy in wsl</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-23 00:00:00" itemprop="dateCreated datePublished" datetime="2025-04-23T00:00:00+01:00">2025-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="🐧-使用-Clash-WSL-安装并配置-Docker-代理访问外网的完整指南"><a href="#🐧-使用-Clash-WSL-安装并配置-Docker-代理访问外网的完整指南" class="headerlink" title="🐧 使用 Clash + WSL 安装并配置 Docker 代理访问外网的完整指南"></a>🐧 使用 Clash + WSL 安装并配置 Docker 代理访问外网的完整指南</h1><blockquote>
<p>本笔记记录了在 Windows 主机上使用 Clash 实现代理，并在 WSL 中配置代理环境与 Docker 访问 Docker Hub 的全过程。</p>
</blockquote>
<hr>
<h2 id="🧱-系统环境"><a href="#🧱-系统环境" class="headerlink" title="🧱 系统环境"></a>🧱 系统环境</h2><ul>
<li>Windows 主机已安装 <strong>Clash for Windows</strong>（英文版）</li>
<li>使用 <strong>WSL2</strong>（Ubuntu 发行版）</li>
<li>在 <strong>WSL 中独立安装了 Docker Engine</strong>（无 Docker Desktop）</li>
</ul>
<hr>
<h2 id="📦-步骤一：Windows-上配置-Clash-for-Windows"><a href="#📦-步骤一：Windows-上配置-Clash-for-Windows" class="headerlink" title="📦 步骤一：Windows 上配置 Clash for Windows"></a>📦 步骤一：Windows 上配置 Clash for Windows</h2><h3 id="1-下载并安装-Clash-for-Windows"><a href="#1-下载并安装-Clash-for-Windows" class="headerlink" title="1. 下载并安装 Clash for Windows"></a>1. 下载并安装 Clash for Windows</h3><p>从 GitHub 下载最新版：<a target="_blank" rel="noopener" href="https://github.com/Fndroid/clash_for_windows_pkg">https://github.com/Fndroid/clash_for_windows_pkg</a></p>
<h3 id="2-导入订阅配置"><a href="#2-导入订阅配置" class="headerlink" title="2. 导入订阅配置"></a>2. 导入订阅配置</h3><ul>
<li>打开 Clash</li>
<li>菜单栏点击 <strong>Profiles</strong></li>
<li>点击 <code>Import</code> → <code>Subscription</code></li>
<li>粘贴你的订阅链接 → 下载并激活</li>
</ul>
<h3 id="3-设置代理模式与端口"><a href="#3-设置代理模式与端口" class="headerlink" title="3. 设置代理模式与端口"></a>3. 设置代理模式与端口</h3><ul>
<li>点击 <strong>General</strong> 标签页<ul>
<li><code>Allow LAN</code>: ✅ 开启</li>
<li><code>Mixed Port</code>: 默认 <code>7890</code>，保留</li>
<li><code>Mode</code>: 推荐选 <strong>Global</strong>（全局代理）</li>
<li><code>System Proxy</code>: 可选开关（影响 Windows 浏览器）</li>
</ul>
</li>
</ul>
<hr>
<h2 id="🌐-步骤二：在-WSL-中设置-Clash-代理"><a href="#🌐-步骤二：在-WSL-中设置-Clash-代理" class="headerlink" title="🌐 步骤二：在 WSL 中设置 Clash 代理"></a>🌐 步骤二：在 WSL 中设置 Clash 代理</h2><h3 id="1-添加以下函数到-bashrc"><a href="#1-添加以下函数到-bashrc" class="headerlink" title="1. 添加以下函数到 ~/.bashrc"></a>1. 添加以下函数到 <code>~/.bashrc</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取代理地址</span></span><br><span class="line"><span class="function"><span class="title">get_proxy_host</span></span>() &#123;</span><br><span class="line">  ip route | grep default | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取代理端口（默认 7890，可通过 PROXY_PORT 环境变量覆盖）</span></span><br><span class="line"><span class="function"><span class="title">get_proxy_port</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;PROXY_PORT:-7890&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用代理</span></span><br><span class="line"><span class="function"><span class="title">proxy_on</span></span>() &#123;</span><br><span class="line">  WIN_PROXY_HOST=$(get_proxy_host)</span><br><span class="line">  WIN_PROXY_PORT=$(get_proxy_port)</span><br><span class="line">  <span class="built_in">export</span> http_proxy=<span class="string">&quot;http://<span class="variable">$&#123;WIN_PROXY_HOST&#125;</span>:<span class="variable">$&#123;WIN_PROXY_PORT&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">export</span> https_proxy=<span class="string">&quot;http://<span class="variable">$&#123;WIN_PROXY_HOST&#125;</span>:<span class="variable">$&#123;WIN_PROXY_PORT&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">export</span> all_proxy=<span class="string">&quot;socks5://<span class="variable">$&#123;WIN_PROXY_HOST&#125;</span>:<span class="variable">$&#123;WIN_PROXY_PORT&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;⚠️ Make sure Clash is running in Windows first.&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;✅ Proxy set to <span class="variable">$WIN_PROXY_HOST</span>:<span class="variable">$WIN_PROXY_PORT</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;----------------------------------------&quot;</span></span><br><span class="line">  curl -s cip.cc || <span class="built_in">echo</span> <span class="string">&quot;❌ curl failed. Clash may not be running or port is blocked.&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;----------------------------------------&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭代理</span></span><br><span class="line"><span class="function"><span class="title">proxy_off</span></span>() &#123;</span><br><span class="line">  <span class="built_in">unset</span> http_proxy</span><br><span class="line">  <span class="built_in">unset</span> https_proxy</span><br><span class="line">  <span class="built_in">unset</span> all_proxy</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Proxy disabled&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-启用代理"><a href="#2-启用代理" class="headerlink" title="2. 启用代理"></a>2. 启用代理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">proxy_on</span><br></pre></td></tr></table></figure>

<p>确认返回 IP 地址为代理出口地址。</p>
<hr>
<h2 id="🐳-步骤三：在-WSL-中运行-Docker-并使用代理拉镜像"><a href="#🐳-步骤三：在-WSL-中运行-Docker-并使用代理拉镜像" class="headerlink" title="🐳 步骤三：在 WSL 中运行 Docker 并使用代理拉镜像"></a>🐳 步骤三：在 WSL 中运行 Docker 并使用代理拉镜像</h2><h3 id="情况：你未启用-systemd，需手动启动-Docker-Daemon"><a href="#情况：你未启用-systemd，需手动启动-Docker-Daemon" class="headerlink" title="情况：你未启用 systemd，需手动启动 Docker Daemon"></a>情况：你未启用 <code>systemd</code>，需手动启动 Docker Daemon</h3><h4 id="1-使用代理启动-Docker-Daemon："><a href="#1-使用代理启动-Docker-Daemon：" class="headerlink" title="1. 使用代理启动 Docker Daemon："></a>1. 使用代理启动 Docker Daemon：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">start_docker_with_proxy</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;🚀 Starting Docker daemon with proxy...&quot;</span></span><br><span class="line">  WIN_PROXY_HOST=$(get_proxy_host)</span><br><span class="line">  WIN_PROXY_PORT=7890</span><br><span class="line">  <span class="built_in">sudo</span> HTTP_PROXY=http://<span class="variable">$&#123;WIN_PROXY_HOST&#125;</span>:<span class="variable">$&#123;WIN_PROXY_PORT&#125;</span> \</span><br><span class="line">       HTTPS_PROXY=http://<span class="variable">$&#123;WIN_PROXY_HOST&#125;</span>:<span class="variable">$&#123;WIN_PROXY_PORT&#125;</span> \</span><br><span class="line">       dockerd &gt; /tmp/dockerd.log 2&gt;&amp;1 &amp;</span><br><span class="line">  <span class="built_in">sleep</span> 2</span><br><span class="line">  docker info &gt; /dev/null 2&gt;&amp;1 &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✅ Docker started&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;❌ Failed to start Docker&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-或使用非代理方式启动（适用于无需翻墙时）"><a href="#2-或使用非代理方式启动（适用于无需翻墙时）" class="headerlink" title="2. 或使用非代理方式启动（适用于无需翻墙时）"></a>2. 或使用非代理方式启动（适用于无需翻墙时）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">start_docker</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;🚀 Starting Docker daemon without proxy...&quot;</span></span><br><span class="line">  <span class="built_in">sudo</span> dockerd &gt; /tmp/dockerd.log 2&gt;&amp;1 &amp;</span><br><span class="line">  <span class="built_in">sleep</span> 2</span><br><span class="line">  docker info &gt; /dev/null 2&gt;&amp;1 &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✅ Docker started&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;❌ Failed to start Docker&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-停止-Docker"><a href="#3-停止-Docker" class="headerlink" title="3. 停止 Docker"></a>3. 停止 Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">stop_docker</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;🛑 Stopping Docker daemon...&quot;</span></span><br><span class="line">  <span class="built_in">sudo</span> pkill dockerd &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✅ Docker daemon stopped&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📁-步骤四：使用-docker-compose-启动-Consul-服务"><a href="#📁-步骤四：使用-docker-compose-启动-Consul-服务" class="headerlink" title="📁 步骤四：使用 docker compose 启动 Consul 服务"></a>📁 步骤四：使用 <code>docker compose</code> 启动 Consul 服务</h2><h3 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1. 项目结构"></a>1. 项目结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/code/projects/gorder/</span><br><span class="line">└── docker-compose.yml</span><br></pre></td></tr></table></figure>

<h3 id="2-示例-docker-compose-yml"><a href="#2-示例-docker-compose-yml" class="headerlink" title="2. 示例 docker-compose.yml"></a>2. 示例 <code>docker-compose.yml</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.9&quot;</span></span><br><span class="line">services:</span><br><span class="line">  consul:</span><br><span class="line">    image: hashicorp/consul</span><br><span class="line">    container_name: consul-server</span><br><span class="line">    <span class="built_in">command</span>: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8500:8500&quot;</span></span><br><span class="line">      - <span class="string">&quot;8600:8600/udp&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-快捷函数或-alias-启动-Consul"><a href="#3-快捷函数或-alias-启动-Consul" class="headerlink" title="3. 快捷函数或 alias 启动 Consul"></a>3. 快捷函数或 alias 启动 Consul</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">start_consul</span></span>() &#123;</span><br><span class="line">  <span class="built_in">cd</span> ~/code/projects/gorder</span><br><span class="line">  docker compose up -d</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> consulup=<span class="string">&#x27;cd ~/code/projects/gorder &amp;&amp; docker compose up -d&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> consuldn=<span class="string">&#x27;cd ~/code/projects/gorder &amp;&amp; docker compose down&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🔁-一键启动全流程（推荐顺序）"><a href="#🔁-一键启动全流程（推荐顺序）" class="headerlink" title="🔁 一键启动全流程（推荐顺序）"></a>🔁 一键启动全流程（推荐顺序）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxy_on                     <span class="comment"># 开启 Clash 网络代理</span></span><br><span class="line">start_docker_with_proxy      <span class="comment"># 启动 Docker Daemon 使用代理</span></span><br><span class="line">start_consul                 <span class="comment"># 启动 Consul 服务</span></span><br></pre></td></tr></table></figure>

<p>关闭时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">consuldn                     <span class="comment"># 停止容器</span></span><br><span class="line">stop_docker                  <span class="comment"># 停止 Docker Daemon</span></span><br><span class="line">proxy_off                    <span class="comment"># 关闭代理</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="✅-常见问题"><a href="#✅-常见问题" class="headerlink" title="✅ 常见问题"></a>✅ 常见问题</h2><table>
<thead>
<tr>
<th>问题</th>
<th>原因</th>
<th>解决方法</th>
</tr>
</thead>
<tbody><tr>
<td><code>curl</code> 能用但 <code>docker pull</code> 失败</td>
<td>Docker daemon 没有使用代理</td>
<td>用 <code>HTTP_PROXY=... dockerd</code> 启动</td>
</tr>
<tr>
<td><code>127.0.0.1:7890</code> 无法连接</td>
<td>WSL 的 localhost ≠ Windows localhost</td>
<td>使用 <code>ip route</code> 获取宿主机地址</td>
</tr>
<tr>
<td><code>docker compose</code> 找不到文件</td>
<td>文件名应为 <code>docker-compose.yml</code></td>
<td>使用标准命名或 <code>-f</code> 指定文件</td>
</tr>
<tr>
<td><code>systemctl</code> 无法使用</td>
<td>WSL 未启用 systemd</td>
<td>添加 <code>/etc/wsl.conf</code> 并重启 WSL</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/23/tech/wsl2_docker_install_guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/23/tech/wsl2_docker_install_guide/" class="post-title-link" itemprop="url">Install Docker in WSL2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-23 00:00:00" itemprop="dateCreated datePublished" datetime="2025-04-23T00:00:00+01:00">2025-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="🐳-WSL2-中安装-Docker-全流程笔记（纯二进制安装方式）"><a href="#🐳-WSL2-中安装-Docker-全流程笔记（纯二进制安装方式）" class="headerlink" title="🐳 WSL2 中安装 Docker 全流程笔记（纯二进制安装方式）"></a>🐳 WSL2 中安装 Docker 全流程笔记（纯二进制安装方式）</h1><blockquote>
<p>本文记录了在 WSL2（Ubuntu 20.04）环境下，通过<strong>二进制方式</strong>安装 Docker 的完整步骤及相关概念解析。适用于无需依赖 Docker Desktop，打造轻量、高效的开发环境。</p>
</blockquote>
<hr>
<h2 id="📦-一、安装流程概述"><a href="#📦-一、安装流程概述" class="headerlink" title="📦 一、安装流程概述"></a>📦 一、安装流程概述</h2><h3 id="1️⃣-下载安装包"><a href="#1️⃣-下载安装包" class="headerlink" title="1️⃣ 下载安装包"></a>1️⃣ 下载安装包</h3><ul>
<li>访问阿里云镜像站下载 Docker 二进制包：</li>
<li>地址：<a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/">https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/docker-24.0.7.tgz</span><br></pre></td></tr></table></figure>

<h3 id="2️⃣-解压并安装"><a href="#2️⃣-解压并安装" class="headerlink" title="2️⃣ 解压并安装"></a>2️⃣ 解压并安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xvzf docker-24.0.7.tgz</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> docker/* /usr/local/bin/</span><br></pre></td></tr></table></figure>

<p>此步骤将 <code>docker</code> 和 <code>dockerd</code> 等核心可执行文件复制到系统路径下。</p>
<hr>
<h2 id="⚙️-二、配置镜像加速器"><a href="#⚙️-二、配置镜像加速器" class="headerlink" title="⚙️ 二、配置镜像加速器"></a>⚙️ 二、配置镜像加速器</h2><p>创建配置文件 <code>/etc/docker/daemon.json</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://&lt;你的阿里云ID&gt;.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>作用：加速拉取 Docker 镜像，解决国内网络问题。</p>
</blockquote>
<p>ACR会为每一个账号（阿里云账号或RAM用户）生成一个镜像加速器地址，配置镜像加速器前，您需要获取镜像加速器地址。</p>
<ol>
<li>登录<a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/?spm=a2c4g.11186623.0.0.75121d82E0FDn8">容器镜像服务控制台</a>。</li>
<li>在左侧导航栏选择<em><strong>*镜像工具** &gt; **镜像加速器*</strong></em></li>
<li>在<strong>镜像加速器</strong>页面获取<strong>加速器地址</strong>。</li>
</ol>
<hr>
<h2 id="🚀-三、启动-Docker-守护进程"><a href="#🚀-三、启动-Docker-守护进程" class="headerlink" title="🚀 三、启动 Docker 守护进程"></a>🚀 三、启动 Docker 守护进程</h2><p>由于 WSL2 默认无 systemd，需手动启动 <code>dockerd</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dockerd &gt; /tmp/dockerd.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<p>或者编写启动脚本 <code>start-docker.sh</code> 方便使用。</p>
<hr>
<h2 id="👤-四、配置用户权限"><a href="#👤-四、配置用户权限" class="headerlink" title="👤 四、配置用户权限"></a>👤 四、配置用户权限</h2><p>避免每次运行 Docker 命令都需要 sudo：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br><span class="line"><span class="built_in">exec</span> su -l <span class="variable">$USER</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="✅-五、验证-Docker-是否安装成功"><a href="#✅-五、验证-Docker-是否安装成功" class="headerlink" title="✅ 五、验证 Docker 是否安装成功"></a>✅ 五、验证 Docker 是否安装成功</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🧠-六、关键概念解析"><a href="#🧠-六、关键概念解析" class="headerlink" title="🧠 六、关键概念解析"></a>🧠 六、关键概念解析</h2><h3 id="1️⃣-dockerd-——-Docker-Daemon（守护进程）"><a href="#1️⃣-dockerd-——-Docker-Daemon（守护进程）" class="headerlink" title="1️⃣ dockerd —— Docker Daemon（守护进程）"></a>1️⃣ <code>dockerd</code> —— Docker Daemon（守护进程）</h3><ul>
<li>负责管理容器、镜像、网络等所有后台服务</li>
<li>必须运行 <code>dockerd</code>，客户端 <code>docker</code> 命令才能工作</li>
</ul>
<h3 id="2️⃣-var-run-docker-sock"><a href="#2️⃣-var-run-docker-sock" class="headerlink" title="2️⃣ /var/run/docker.sock"></a>2️⃣ <code>/var/run/docker.sock</code></h3><ul>
<li>Docker 客户端与守护进程通信的 Unix Socket 文件</li>
<li>权限不足会导致 <code>permission denied</code> 错误</li>
</ul>
<h3 id="3️⃣-daemon-json"><a href="#3️⃣-daemon-json" class="headerlink" title="3️⃣ daemon.json"></a>3️⃣ <code>daemon.json</code></h3><ul>
<li>Docker 的主配置文件，通常用于设置镜像加速器、日志驱动等</li>
<li>位置：<code>/etc/docker/daemon.json</code></li>
</ul>
<h3 id="4️⃣-镜像加速器"><a href="#4️⃣-镜像加速器" class="headerlink" title="4️⃣ 镜像加速器"></a>4️⃣ 镜像加速器</h3><ul>
<li>国内访问 Docker Hub 缓慢，通过阿里云、网易等提供的加速服务，大幅提升镜像拉取速度</li>
</ul>
<hr>
<h2 id="📌-七、常用命令总结"><a href="#📌-七、常用命令总结" class="headerlink" title="📌 七、常用命令总结"></a>📌 七、常用命令总结</h2><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>sudo dockerd &amp;</code></td>
<td>启动 Docker 后台服务</td>
</tr>
<tr>
<td><code>docker ps</code></td>
<td>查看运行中的容器</td>
</tr>
<tr>
<td><code>docker images</code></td>
<td>查看本地镜像</td>
</tr>
<tr>
<td><code>docker run hello-world</code></td>
<td>测试 Docker 是否正常运行</td>
</tr>
<tr>
<td><code>docker stop &lt;容器ID&gt;</code></td>
<td>停止容器</td>
</tr>
<tr>
<td><code>docker rm &lt;容器ID&gt;</code></td>
<td>删除容器</td>
</tr>
</tbody></table>
<hr>
<blockquote>
<p>本文档适用于个人开发环境，生产环境建议结合 systemd 或使用 Docker Desktop。</p>
</blockquote>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p><code>docker_start.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dockerd &gt; /tmp/dockerd.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>



<p>注: 一下脚本不合适国内网络环境, APT get不到, 其中安装的多个应用:</p>
<p><code>docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</code></p>
<p>均涵盖在阿里云镜像的二进制程序压缩包中</p>
<p><code>wsl2_docker_install.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># WSL2 安装 Docker Engine 脚本 (适用于 Ubuntu)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;🚨 清理旧版本 Docker...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> apt purge -y docker.io docker-doc docker-compose docker-compose-v2 docker-engine docker containerd runc</span><br><span class="line"><span class="built_in">sudo</span> apt autoremove -y</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ 安装依赖...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install -y ca-certificates curl gnupg lsb-release</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;🔑 添加 Docker 官方 GPG 密钥...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;📦 添加 Docker APT 源...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;🚀 开始安装 Docker Engine...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ Docker 安装完成！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;⚡ 配置阿里云镜像加速器...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://&lt;你的阿里云ID&gt;.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;🚨 注意：WSL2 无法使用 systemd 启动 Docker 服务&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;👉 请使用以下命令手动启动 Docker 守护进程：&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sudo dockerd &gt; /tmp/dockerd.log 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;💡 启动后，使用 &#x27;docker ps&#x27; 进行验证&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/12/tech/linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/12/tech/linux/" class="post-title-link" itemprop="url">Linux Common Operations</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-12 00:00:00" itemprop="dateCreated datePublished" datetime="2025-04-12T00:00:00+01:00">2025-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="🐧-Linux-常见操作对照手册（类比-Windows-系统）"><a href="#🐧-Linux-常见操作对照手册（类比-Windows-系统）" class="headerlink" title="🐧 Linux 常见操作对照手册（类比 Windows 系统）"></a>🐧 Linux 常见操作对照手册（类比 Windows 系统）</h1><blockquote>
<p>本文旨在帮助熟悉 Windows 系统的用户快速掌握 Linux 中的常用系统操作，同时补充常用命令的含义便于记忆。</p>
</blockquote>
<hr>
<h2 id="🧠-基础信息查看"><a href="#🧠-基础信息查看" class="headerlink" title="🧠 基础信息查看"></a>🧠 基础信息查看</h2><h3 id="查看当前用户名（whoami-→-who-am-i）"><a href="#查看当前用户名（whoami-→-who-am-i）" class="headerlink" title="查看当前用户名（whoami → who am i）"></a>查看当前用户名（whoami → who am i）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">whoami</span>  <span class="comment"># 显示当前登录用户（who am I）</span></span><br></pre></td></tr></table></figure>

<h3 id="查看当前所在路径（pwd-→-print-working-directory）"><a href="#查看当前所在路径（pwd-→-print-working-directory）" class="headerlink" title="查看当前所在路径（pwd → print working directory）"></a>查看当前所在路径（pwd → print working directory）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span>  <span class="comment"># 显示当前所在的绝对路径</span></span><br></pre></td></tr></table></figure>

<h3 id="查看系统信息（uname-→-unix-name）"><a href="#查看系统信息（uname-→-unix-name）" class="headerlink" title="查看系统信息（uname → unix name）"></a>查看系统信息（uname → unix name）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uname</span> -a         <span class="comment"># 查看内核版本、架构</span></span><br><span class="line">lsb_release -a   <span class="comment"># 查看发行版信息</span></span><br><span class="line">hostnamectl      <span class="comment"># 显示主机名和系统版本等信息</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📁-文件与目录操作"><a href="#📁-文件与目录操作" class="headerlink" title="📁 文件与目录操作"></a>📁 文件与目录操作</h2><h3 id="查看目录内容（ls-→-list-segments）"><a href="#查看目录内容（ls-→-list-segments）" class="headerlink" title="查看目录内容（ls → list segments）"></a>查看目录内容（ls → list segments）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -lh      <span class="comment"># 列出当前目录下的文件，带单位和时间</span></span><br><span class="line"><span class="built_in">ls</span> -a       <span class="comment"># 显示所有文件，包括隐藏文件（以.开头）</span></span><br><span class="line"><span class="built_in">ls</span> -R       <span class="comment"># 递归列出所有子目录内容</span></span><br></pre></td></tr></table></figure>

<h3 id="复制-移动-删除-文件"><a href="#复制-移动-删除-文件" class="headerlink" title="复制 &#x2F; 移动 &#x2F; 删除 文件"></a>复制 &#x2F; 移动 &#x2F; 删除 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> file1 file2       <span class="comment"># cp → copy，复制文件</span></span><br><span class="line"><span class="built_in">cp</span> -r dir1 dir2      <span class="comment"># 递归复制整个目录</span></span><br><span class="line"><span class="built_in">mv</span> file newname      <span class="comment"># mv → move，移动或重命名文件</span></span><br><span class="line"><span class="built_in">rm</span> file.txt          <span class="comment"># rm → remove，删除文件</span></span><br><span class="line"><span class="built_in">rm</span> -r folder/        <span class="comment"># 递归删除文件夹</span></span><br></pre></td></tr></table></figure>

<h3 id="修改文件权限（chmod-→-change-mode）"><a href="#修改文件权限（chmod-→-change-mode）" class="headerlink" title="修改文件权限（chmod → change mode）"></a>修改文件权限（chmod → change mode）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x run.sh      <span class="comment"># 增加执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> 644 file.txt   <span class="comment"># 设定具体权限（rw-r--r--）</span></span><br></pre></td></tr></table></figure>

<h3 id="7-修改归属用户和组（chown-→-change-owner）"><a href="#7-修改归属用户和组（chown-→-change-owner）" class="headerlink" title="7. 修改归属用户和组（chown → change owner）"></a>7. 修改归属用户和组（chown → change owner）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chown</span> yifan file.txt  <span class="comment"># 把文件归属更改为 yifan</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📋-文件查看与编辑"><a href="#📋-文件查看与编辑" class="headerlink" title="📋 文件查看与编辑"></a>📋 文件查看与编辑</h2><h3 id="快速查看文件内容"><a href="#快速查看文件内容" class="headerlink" title="快速查看文件内容"></a>快速查看文件内容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> file.txt         <span class="comment"># cat → concatenate，一次性查看全部内容</span></span><br><span class="line">less file.txt        <span class="comment"># 分页查看，可上下翻页</span></span><br><span class="line"><span class="built_in">head</span> -n 10 file.txt  <span class="comment"># 显示前 10 行</span></span><br><span class="line"><span class="built_in">tail</span> -n 10 file.txt  <span class="comment"># 显示后 10 行</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> $(find dir1 dir2 -<span class="built_in">type</span> f) <span class="comment"># 打印出 dir1 dir2 目录下所有文件的内容 (递归进行)</span></span><br><span class="line"></span><br><span class="line">find dir1 dir2 -<span class="built_in">type</span> f | <span class="keyword">while</span> <span class="built_in">read</span> file; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;===== <span class="variable">$file</span> =====&quot;</span></span><br><span class="line">  <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span></span><br><span class="line"><span class="keyword">done</span> <span class="comment"># 在文件与文件之间加上 ===== 文件名 =====</span></span><br><span class="line"></span><br><span class="line">find dir1 dir2 -<span class="built_in">type</span> f -name <span class="string">&quot;*.java&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> file; <span class="keyword">do</span> <span class="comment"># 限制文件类型</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;===== <span class="variable">$file</span> =====&quot;</span></span><br><span class="line">  <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="编辑文件"><a href="#编辑文件" class="headerlink" title="编辑文件"></a>编辑文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nano file.txt        <span class="comment"># 终端内简单编辑器</span></span><br><span class="line">vim file.txt         <span class="comment"># 高级编辑器（vi improved）</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="💻-系统资源管理"><a href="#💻-系统资源管理" class="headerlink" title="💻 系统资源管理"></a>💻 系统资源管理</h2><h3 id="查看进程（top-→-table-of-processes）"><a href="#查看进程（top-→-table-of-processes）" class="headerlink" title="查看进程（top → table of processes）"></a>查看进程（top → table of processes）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top        <span class="comment"># 实时显示系统进程和资源占用</span></span><br><span class="line">htop       <span class="comment"># 更友好、图形化的 top</span></span><br><span class="line">ps aux     <span class="comment"># 显示所有进程详细信息（ps → process status）</span></span><br></pre></td></tr></table></figure>

<h3 id="查看端口和连接（ss-→-socket-statistics）"><a href="#查看端口和连接（ss-→-socket-statistics）" class="headerlink" title="查看端口和连接（ss → socket statistics）"></a>查看端口和连接（ss → socket statistics）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ss -tulnp</span><br><span class="line"><span class="comment"># -p: 表示显示 监听该端口的进程（PID/名称）</span></span><br><span class="line"><span class="comment"># -n：不解析服务名称（例如显示 3306 而不是 mysql）</span></span><br><span class="line"><span class="comment"># -l：只显示监听状态（Listen）</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ss -tuln           <span class="comment"># 显示监听的 TCP/UDP 端口</span></span><br><span class="line">lsof -i:8080       <span class="comment"># 查看哪个进程占用端口（lsof → list open files）</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="💿-磁盘与空间"><a href="#💿-磁盘与空间" class="headerlink" title="💿 磁盘与空间"></a>💿 磁盘与空间</h2><h3 id="查看磁盘使用情况（df-→-disk-free）"><a href="#查看磁盘使用情况（df-→-disk-free）" class="headerlink" title="查看磁盘使用情况（df → disk free）"></a>查看磁盘使用情况（df → disk free）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h  <span class="comment"># 查看每个挂载点的磁盘使用情况</span></span><br></pre></td></tr></table></figure>

<h3 id="查看目录大小（du-→-disk-usage）"><a href="#查看目录大小（du-→-disk-usage）" class="headerlink" title="查看目录大小（du → disk usage）"></a>查看目录大小（du → disk usage）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">du</span> -sh .    <span class="comment"># 当前目录总大小</span></span><br><span class="line"><span class="built_in">du</span> -sh *    <span class="comment"># 当前目录下各文件/目录大小</span></span><br></pre></td></tr></table></figure>

<h3 id="查看内存使用情况"><a href="#查看内存使用情况" class="headerlink" title="查看内存使用情况"></a>查看内存使用情况</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -h  <span class="comment"># 显示内存和 swap 使用情况</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🧩-软件包管理"><a href="#🧩-软件包管理" class="headerlink" title="🧩 软件包管理"></a>🧩 软件包管理</h2><h3 id="安装程序（apt-→-advanced-package-tool）"><a href="#安装程序（apt-→-advanced-package-tool）" class="headerlink" title="安装程序（apt → advanced package tool）"></a>安装程序（apt → advanced package tool）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install &lt;软件名&gt;</span><br></pre></td></tr></table></figure>

<h3 id="查看已安装的软件"><a href="#查看已安装的软件" class="headerlink" title="查看已安装的软件"></a>查看已安装的软件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -l  <span class="comment"># 列出所有安装的软件包</span></span><br></pre></td></tr></table></figure>

<h3 id="卸载程序"><a href="#卸载程序" class="headerlink" title="卸载程序"></a>卸载程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt remove &lt;软件名&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="⚙️-服务与启动项管理"><a href="#⚙️-服务与启动项管理" class="headerlink" title="⚙️ 服务与启动项管理"></a>⚙️ 服务与启动项管理</h2><h3 id="查看服务状态（systemctl-→-system-control）"><a href="#查看服务状态（systemctl-→-system-control）" class="headerlink" title="查看服务状态（systemctl → system control）"></a>查看服务状态（systemctl → system control）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl status mysql</span><br></pre></td></tr></table></figure>

<h3 id="启动-停止-重启服务"><a href="#启动-停止-重启服务" class="headerlink" title="启动 &#x2F; 停止 &#x2F; 重启服务"></a>启动 &#x2F; 停止 &#x2F; 重启服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl stop redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart redis</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🌐-网络相关"><a href="#🌐-网络相关" class="headerlink" title="🌐 网络相关"></a>🌐 网络相关</h2><h3 id="查看-IP-地址"><a href="#查看-IP-地址" class="headerlink" title="查看 IP 地址"></a>查看 IP 地址</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip a           <span class="comment"># 查看详细 IP 信息</span></span><br><span class="line">hostname -I    <span class="comment"># 快速查看主机 IP</span></span><br></pre></td></tr></table></figure>

<h3 id="测试网络连接"><a href="#测试网络连接" class="headerlink" title="测试网络连接"></a>测试网络连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ping www.baidu.com</span><br><span class="line">curl -I https://google.com</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="✅-推荐工具汇总"><a href="#✅-推荐工具汇总" class="headerlink" title="✅ 推荐工具汇总"></a>✅ 推荐工具汇总</h2><table>
<thead>
<tr>
<th>工具</th>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>htop</td>
<td><code>sudo apt install htop</code></td>
<td>进程查看器，替代 top</td>
</tr>
<tr>
<td>ncdu</td>
<td><code>sudo apt install ncdu</code></td>
<td>图形化查看目录大小</td>
</tr>
<tr>
<td>tree</td>
<td><code>sudo apt install tree</code></td>
<td>以树形结构显示目录</td>
</tr>
</tbody></table>
<hr>
<blockquote>
<p>本文由 ChatGPT 整理生成，适合初中高级 Linux 使用者类比 Windows 熟练掌握系统常见操作。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/12/tech/vmware/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/12/tech/vmware/" class="post-title-link" itemprop="url">VMware</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-12 00:00:00" itemprop="dateCreated datePublished" datetime="2025-04-12T00:00:00+01:00">2025-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h2 id="🧱-一、安装虚拟机"><a href="#🧱-一、安装虚拟机" class="headerlink" title="🧱 一、安装虚拟机"></a>🧱 一、安装虚拟机</h2><p>你选择使用 <strong>VMware Workstation Pro</strong>（现已免费），作为运行虚拟系统的工具：</p>
<ul>
<li>✅ VMware 是一个功能全面的虚拟机管理平台</li>
<li>✅ 支持安装在 D 盘（你已经完成）</li>
<li>✅ 虚拟系统（如 Ubuntu）的镜像和文件可以独立放置（如 D:\VMs\Ubuntu18-dev）</li>
<li>✅ 成功从 <a target="_blank" rel="noopener" href="https://releases.ubuntu.com/">Ubuntu Releases</a> 下载并使用 ISO 安装 Ubuntu 18.04</li>
</ul>
<hr>
<h2 id="⚙️-二、虚拟机配置"><a href="#⚙️-二、虚拟机配置" class="headerlink" title="⚙️ 二、虚拟机配置"></a>⚙️ 二、虚拟机配置</h2><p>你完成并了解了以下配置操作：</p>
<ul>
<li>✅ 安装 Ubuntu 18.04 系统，并了解虚拟硬件（CPU、内存、磁盘等）配置建议：<ul>
<li>你本机为 8 核，虚拟机分配 2~4 核较为合理</li>
</ul>
</li>
<li>✅ 安装 VMware Tools，实现分辨率自适应、拖拽复制、共享剪贴板等</li>
<li>✅ 学会使用 GUI 设置图标大小、启用 fractional scaling 改变 UI 缩放比例</li>
<li>✅ 学会安全关机和修改虚拟机 CPU 配置（需关机后设置）</li>
</ul>
<hr>
<h2 id="👤-三、Linux-系统用户问题"><a href="#👤-三、Linux-系统用户问题" class="headerlink" title="👤 三、Linux 系统用户问题"></a>👤 三、Linux 系统用户问题</h2><p>你提出了非常核心的问题，理解了 Linux 与 Windows 在用户管理上的差异：</p>
<ul>
<li>✅ 每个用户都有独立的 home 目录（如 <code>/home/ypy</code>）</li>
<li>✅ 普通用户需使用 <code>sudo</code> 来执行系统级任务（如安装软件）</li>
<li>✅ root 是最高权限用户，但 Ubuntu 默认禁用 root 密码，推荐使用 <code>sudo -i</code> 进入 root shell</li>
<li>✅ 使用 <code>whoami</code>, <code>id</code>, <code>cat /etc/passwd</code> 来查看用户信息</li>
<li>✅ 软件安装通常是“全局一次安装，所有用户共享”，非每人安装一份</li>
</ul>
<hr>
<h2 id="📁-四、Linux-系统常用（重要）文件夹"><a href="#📁-四、Linux-系统常用（重要）文件夹" class="headerlink" title="📁 四、Linux 系统常用（重要）文件夹"></a>📁 四、Linux 系统常用（重要）文件夹</h2><p>你复习并理解了 Linux 文件系统的树状结构，以 <code>/</code> 为根：</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>/home</code></td>
<td>用户主目录，开发者日常使用区域</td>
</tr>
<tr>
<td><code>/usr/bin</code></td>
<td>可执行程序位置</td>
</tr>
<tr>
<td><code>/etc</code></td>
<td>配置文件位置</td>
</tr>
<tr>
<td><code>/var/lib</code></td>
<td>应用数据（如数据库）</td>
</tr>
<tr>
<td><code>/tmp</code></td>
<td>临时文件</td>
</tr>
<tr>
<td><code>/root</code></td>
<td>root 用户的 home 目录</td>
</tr>
<tr>
<td><code>/opt</code></td>
<td>可选安装目录（第三方程序）</td>
</tr>
</tbody></table>
<p>你也学会了在 <strong>图形界面中访问根目录</strong>（点击“其他位置” → “Computer”）。</p>
<hr>
<h2 id="🧰-五、Linux-安装软件问题"><a href="#🧰-五、Linux-安装软件问题" class="headerlink" title="🧰 五、Linux 安装软件问题"></a>🧰 五、Linux 安装软件问题</h2><p>你非常深入地探讨了 Ubuntu 如何避免 Windows 中“卸载不干净”的问题，并理解了：</p>
<ul>
<li><p>✅ Ubuntu 使用 <code>apt</code> 包管理器进行软件安装与卸载</p>
</li>
<li><p>✅ 所有程序会统一装入标准目录（无乱放、无注册表）</p>
</li>
<li><p>✅ 卸载软件可以使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt remove 软件名      <span class="comment"># 卸载程序但保留配置</span></span><br><span class="line"><span class="built_in">sudo</span> apt purge 软件名       <span class="comment"># 连配置一并清除</span></span><br><span class="line"><span class="built_in">sudo</span> apt autoremove         <span class="comment"># 清除无用依赖</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>✅ 你亲手完成了：</p>
<ul>
<li>卸载 Firefox</li>
<li>安装 Google Chrome（通过官网 <code>.deb</code> 安装包或 <code>wget + dpkg</code>）</li>
</ul>
</li>
</ul>
<hr>
<h2 id="🔧-六、配置-Git（连接-GitHub）"><a href="#🔧-六、配置-Git（连接-GitHub）" class="headerlink" title="🔧 六、配置 Git（连接 GitHub）"></a>🔧 六、配置 Git（连接 GitHub）</h2><p>你理解了远程开发中 Git 的重要性，并在虚拟机中完成了以下配置：</p>
<ul>
<li><p>✅ 安装 Git：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install git</span><br></pre></td></tr></table></figure>
</li>
<li><p>✅ 设置 Git 用户信息（提交用）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;peiyouyao&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;peiyouyao@gmail.com&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>✅ 生成 SSH 密钥对（ed25519），用于连接 GitHub：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ed25519 -C <span class="string">&quot;你的邮箱&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>✅ 成功将公钥添加到 GitHub（Settings → SSH Keys）</p>
</li>
<li><p>✅ 测试连接成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>✅ 支持在虚拟机中使用 SSH 克隆、提交、推送 GitHub 仓库</p>
</li>
</ul>
<h2 id="安装SSH服务"><a href="#安装SSH服务" class="headerlink" title="安装SSH服务"></a>安装SSH服务</h2><table>
<thead>
<tr>
<th>步骤</th>
<th>命令（在虚拟机中）</th>
</tr>
</thead>
<tbody><tr>
<td>检查 IP</td>
<td><code>ip a</code></td>
</tr>
<tr>
<td>安装 SSH 服务</td>
<td><code>sudo apt install openssh-server</code></td>
</tr>
<tr>
<td>启动服务</td>
<td><code>sudo systemctl start ssh</code></td>
</tr>
<tr>
<td>设置开机启动</td>
<td><code>sudo systemctl enable ssh</code></td>
</tr>
<tr>
<td>检查状态</td>
<td><code>sudo systemctl status ssh</code></td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/12/tech/wsl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/12/tech/wsl/" class="post-title-link" itemprop="url">WSL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-12 00:00:00" itemprop="dateCreated datePublished" datetime="2025-04-12T00:00:00+01:00">2025-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="🐧-WSL-安装与配置笔记"><a href="#🐧-WSL-安装与配置笔记" class="headerlink" title="🐧 WSL 安装与配置笔记"></a>🐧 WSL 安装与配置笔记</h1><hr>
<h2 id="✅-一、WSL-的安装与说明"><a href="#✅-一、WSL-的安装与说明" class="headerlink" title="✅ 一、WSL 的安装与说明"></a>✅ 一、WSL 的安装与说明</h2><h3 id="📌-为什么使用-WSL："><a href="#📌-为什么使用-WSL：" class="headerlink" title="📌 为什么使用 WSL："></a>📌 为什么使用 WSL：</h3><ul>
<li>官方集成，资源轻，占用少，启动快</li>
<li>兼容大部分 Linux 命令、开发工具</li>
<li>支持 GUI（WSLg），可运行 Linux 图形程序</li>
<li>可直接访问 Windows 文件系统（<code>/mnt/c/...</code>）</li>
</ul>
<h3 id="📦-安装命令（管理员-PowerShell）："><a href="#📦-安装命令（管理员-PowerShell）：" class="headerlink" title="📦 安装命令（管理员 PowerShell）："></a>📦 安装命令（管理员 PowerShell）：</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl <span class="literal">--install</span></span><br></pre></td></tr></table></figure>

<p>默认安装 Ubuntu（最新版）+ WSL2 平台。</p>
<hr>
<h2 id="✅-二、安装-Ubuntu-虚拟机至-D-盘"><a href="#✅-二、安装-Ubuntu-虚拟机至-D-盘" class="headerlink" title="✅ 二、安装 Ubuntu 虚拟机至 D 盘"></a>✅ 二、安装 Ubuntu 虚拟机至 D 盘</h2><blockquote>
<p>为节省空间，避免默认安装在 C:\Users\AppData</p>
</blockquote>
<h3 id="🧩-步骤："><a href="#🧩-步骤：" class="headerlink" title="🧩 步骤："></a>🧩 步骤：</h3><ol>
<li>下载 Ubuntu Appx 安装包：<ul>
<li><a target="_blank" rel="noopener" href="https://aka.ms/wslubuntu2004">https://aka.ms/wslubuntu2004</a></li>
</ul>
</li>
<li>解压并手动注册：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 .appx 改名为 .zip 并解压</span></span><br><span class="line">Rename-Item .\Ubuntu_*.appx ubuntu.zip</span><br><span class="line">Expand-Archive .\ubuntu.zip .\</span><br><span class="line">.\ubuntu.exe</span><br></pre></td></tr></table></figure>

<p>设置用户名密码，即初始化成功。</p>
<hr>
<h2 id="✅-三、WSL-虚拟机初始化配置（推荐安装脚本）"><a href="#✅-三、WSL-虚拟机初始化配置（推荐安装脚本）" class="headerlink" title="✅ 三、WSL 虚拟机初始化配置（推荐安装脚本）"></a>✅ 三、WSL 虚拟机初始化配置（推荐安装脚本）</h2><h3 id="⚙️-更新-基础工具安装："><a href="#⚙️-更新-基础工具安装：" class="headerlink" title="⚙️ 更新 &amp; 基础工具安装："></a>⚙️ 更新 &amp; 基础工具安装：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt upgrade -y</span><br><span class="line"><span class="built_in">sudo</span> apt install -y git curl wget unzip vim net-tools htop</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="✅-四、Git-SSH-配置"><a href="#✅-四、Git-SSH-配置" class="headerlink" title="✅ 四、Git + SSH 配置"></a>✅ 四、Git + SSH 配置</h2><h3 id="1️⃣-Git-安装与全局配置："><a href="#1️⃣-Git-安装与全局配置：" class="headerlink" title="1️⃣ Git 安装与全局配置："></a>1️⃣ Git 安装与全局配置：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install git -y</span><br><span class="line"></span><br><span class="line">git config --global user.name <span class="string">&quot;xxx&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;your_email@example.com&quot;</span></span><br><span class="line">git config --global core.editor <span class="string">&quot;vim&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2️⃣-SSH-密钥生成与配置："><a href="#2️⃣-SSH-密钥生成与配置：" class="headerlink" title="2️⃣ SSH 密钥生成与配置："></a>2️⃣ SSH 密钥生成与配置：</h3><h4 id="生成-SSH-密钥（本地和-WSL-各自生成）："><a href="#生成-SSH-密钥（本地和-WSL-各自生成）：" class="headerlink" title="生成 SSH 密钥（本地和 WSL 各自生成）："></a>生成 SSH 密钥（本地和 WSL 各自生成）：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ed25519 -C <span class="string">&quot;your_email@example.com&quot;</span></span><br></pre></td></tr></table></figure>

<p>按提示一路回车，默认保存在：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/.ssh/id_ed25519</span><br><span class="line">~/.ssh/id_ed25519.pub</span><br></pre></td></tr></table></figure>

<h4 id="将公钥添加到-GitHub："><a href="#将公钥添加到-GitHub：" class="headerlink" title="将公钥添加到 GitHub："></a>将公钥添加到 GitHub：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> ~/.ssh/id_ed25519.pub</span><br></pre></td></tr></table></figure>

<p>复制粘贴至 GitHub → <code>Settings &gt; SSH and GPG Keys &gt; New Key</code></p>
<hr>
<h3 id="3️⃣-在-Windows-主机配置-SSH-连接-Ubuntu-虚拟机"><a href="#3️⃣-在-Windows-主机配置-SSH-连接-Ubuntu-虚拟机" class="headerlink" title="3️⃣ 在 Windows 主机配置 SSH 连接 Ubuntu 虚拟机"></a>3️⃣ 在 Windows 主机配置 SSH 连接 Ubuntu 虚拟机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 C:\Users\&lt;你&gt;\.ssh\config</span></span><br><span class="line">Host ubuntu-wsl</span><br><span class="line">    HostName 172.27.xxx.xxx         <span class="comment"># 用 `ip addr show eth0` 获取</span></span><br><span class="line">    User ypy</span><br><span class="line">    IdentityFile C:/Users/&lt;你&gt;/.ssh/id_ed25519</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="✅-五、远程-VSCode-开发推荐做法"><a href="#✅-五、远程-VSCode-开发推荐做法" class="headerlink" title="✅ 五、远程 VSCode 开发推荐做法"></a>✅ 五、远程 VSCode 开发推荐做法</h2><ul>
<li>安装 VSCode</li>
<li>安装扩展：<code>Remote - SSH</code> + <code>WSL</code></li>
<li>用 <code>ssh ubuntu-wsl</code> 测试连接</li>
<li>成功连接后，使用 VSCode 的 Remote SSH 自动同步开发环境</li>
</ul>
<hr>
<h2 id="✅-六、SSH-服务启动命令（不使用-systemctl）"><a href="#✅-六、SSH-服务启动命令（不使用-systemctl）" class="headerlink" title="✅ 六、SSH 服务启动命令（不使用 systemctl）"></a>✅ 六、SSH 服务启动命令（不使用 systemctl）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install openssh-server -y</span><br><span class="line"><span class="built_in">sudo</span> service ssh start    <span class="comment"># 启动 sshd</span></span><br><span class="line">ps -ef | grep sshd        <span class="comment"># 查看服务状态</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📁-附：常用路径小抄"><a href="#📁-附：常用路径小抄" class="headerlink" title="📁 附：常用路径小抄"></a>📁 附：常用路径小抄</h2><table>
<thead>
<tr>
<th>路径</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>~/.ssh/authorized_keys</code></td>
<td>存储允许登录的公钥</td>
</tr>
<tr>
<td><code>/mnt/c/...</code></td>
<td>访问 Windows C 盘</td>
</tr>
<tr>
<td><code>\\wsl$\Ubuntu</code></td>
<td>Windows 访问 Linux 文件系统</td>
</tr>
<tr>
<td><code>~/WorkStation/...</code></td>
<td>你的开发工作区目录</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/01/tech/rpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/01/tech/rpc/" class="post-title-link" itemprop="url">PyRPC Framework</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-02-01 00:00:00" itemprop="dateCreated datePublished" datetime="2025-02-01T00:00:00+00:00">2025-02-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<blockquote>
<p>In this blog, I will give an elaborate instruction to the process of how to construct a whole RPC framework with Java. </p>
<p>It is also a record of project <a target="_blank" rel="noopener" href="https://github.com/peiyouyao/demo-pyrpc">demo-pyrpc</a> and <a target="_blank" rel="noopener" href="https://github.com/peiyouyao/demo-rpc">demo-rpc</a>, the former one is an update on the last one.</p>
</blockquote>
<h1 id="pyRPC-Framework"><a href="#pyRPC-Framework" class="headerlink" title="pyRPC Framework"></a>pyRPC Framework</h1><h2 id="What-is-RPC"><a href="#What-is-RPC" class="headerlink" title="What is RPC?"></a>What is RPC?</h2><p>RPC (Remote Procedure Call) 远程过程调用, 是一种计算机通信协议, 允许程序在不同计算机之间通信和交互, 就像本地调用一样.</p>
<h2 id="Consumer-Provider-Model"><a href="#Consumer-Provider-Model" class="headerlink" title="Consumer &#x2F; Provider Model"></a>Consumer &#x2F; Provider Model</h2><p>RPC 框架本身不是一个独立运行的服务, 而是一个被 Consumer (调用方) 和 Provider (服务提供方) 引入的库 (SDK). RPC 框架的主要作用是为开发者提供远程服务调用的能力; 同时抽象网络通信, 序列化&#x2F;反序列化等底层细节. </p>
<p>RPC 完成通信的主要过程为:</p>
<h3 id="共享模块-common-example"><a href="#共享模块-common-example" class="headerlink" title="共享模块 (common-example)"></a>共享模块 (common-example)</h3><ul>
<li>共享模块 (SDK), 不在服务器上运行, 给各个开发组件提供规范化的数据类型和接口</li>
<li>有两个实体类: <code>User</code> and <code>Music</code>, 含有基本数据类型和集合数据类型</li>
<li>规定两个接口: <code>UserService</code> and <code>MusicService</code>, 包含 <code>getUserById</code> and <code>getMusicById</code> 方法</li>
</ul>
<h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><ul>
<li>需引入 common-example &amp; pyrpc</li>
<li>模拟服务消费者, 运行在服务器上</li>
</ul>
<h4 id="zero-初始化-Consumer-端配置"><a href="#zero-初始化-Consumer-端配置" class="headerlink" title=":zero:初始化 Consumer 端配置"></a>:zero:初始化 Consumer 端配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RpcApplication.init();</span><br></pre></td></tr></table></figure>

<p>主要是读取 Consumer 端的配置信息. </p>
<h4 id="one-Consumer-使用动态代理工厂-ServiceProxyFactory-获取代理对象"><a href="#one-Consumer-使用动态代理工厂-ServiceProxyFactory-获取代理对象" class="headerlink" title=":one:Consumer 使用动态代理工厂 ServiceProxyFactory 获取代理对象"></a>:one:Consumer 使用动态代理工厂 <code>ServiceProxyFactory</code> 获取代理对象</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserService userService = ServiceProxyFactory.getProxy(UserService.class);</span><br></pre></td></tr></table></figure>

<p>然后就可以对 <code>userService</code> 像在本地一样调用其中的方法.</p>
<p>其中 <code>ServiceProxyFactory</code> 内部存储了 <code>ServiceProxy</code> 的实例 (使用 static 的单例存储, 避免过多的对象创建). </p>
<h4 id="two-ServiceProxy-帮助-Consumer-完成对请求的封装-发送-并接受响应"><a href="#two-ServiceProxy-帮助-Consumer-完成对请求的封装-发送-并接受响应" class="headerlink" title=":two:ServiceProxy 帮助 Consumer 完成对请求的封装, 发送, 并接受响应"></a>:two:<code>ServiceProxy</code> 帮助 Consumer 完成对请求的封装, 发送, 并接受响应</h4><p>在 <code>ServiceProxy</code> 中, 执行了以下关键内容:</p>
<ol>
<li><p>将调用者调用的方法, 传入的参数封装成标准化的 <code>RpcRequest rpcRequest</code></p>
</li>
<li><p>使用序列化器序列化 <code>rpcRequest</code></p>
</li>
<li><p>向 Provider 的的 RPC 服务端点发送请求</p>
</li>
<li><p>待获取 RPC 的响应数据后, 反序列化它, 将其转化成 <code>RpcResponse rpcResponse</code>, 并抽取其中的数据字段 (这才是 Consumer 真正想拿到的东西)</p>
</li>
</ol>
<h3 id="Provider-provider-example"><a href="#Provider-provider-example" class="headerlink" title="Provider (provider-example)"></a>Provider (provider-example)</h3><ul>
<li>需引入 common-example &amp; pyrpc</li>
<li>模拟服务提供者, 运行在服务器上</li>
<li>它实现了共享模块中的 <code>UserService</code> and <code>MusicService</code></li>
</ul>
<h4 id="zero-Provider-的初始化流程"><a href="#zero-Provider-的初始化流程" class="headerlink" title=":zero:Provider 的初始化流程"></a>:zero:Provider 的初始化流程</h4><ol>
<li><p>读入配置信息</p>
</li>
<li><p>把自己想提供的服务注册到 <code>RpcLocalRegistry</code> (本地注册中心)</p>
</li>
<li><p>开启一个Web 服务器, 监听 RPC 请求</p>
</li>
</ol>
<h4 id="one-RpcServer帮助-Provider-完成对请求的接收-解析-并发送响应"><a href="#one-RpcServer帮助-Provider-完成对请求的接收-解析-并发送响应" class="headerlink" title=":one:RpcServer帮助 Provider 完成对请求的接收, 解析, 并发送响应"></a>:one:<code>RpcServer</code>帮助 Provider 完成对请求的接收, 解析, 并发送响应</h4><p>RPC 框架帮助 Provider 接受并处理请求的核心逻辑在 <code>server</code> 包中, 即开启一个 Web 服务器来处理发送过来的 RPC 请求, 并把结果发送回去; 而其中的处理请求的逻辑, 则单独封装在 <code>ServerHandler</code> 中. </p>
<p><code>RpcServer</code> 中的逻辑是一个异步处理模型. 当有请求过来时, 遵循以下步骤: 请求解析 -&gt; 服务方法调用 -&gt; 结果封装 -&gt; 响应返回. </p>
<h3 id="RPC-pyrpc"><a href="#RPC-pyrpc" class="headerlink" title="RPC (pyrpc)"></a>RPC (pyrpc)</h3><p>连接 Consumer 和 Provider 通信的枢纽, 接下来重点介绍.</p>
<h2 id="Main-Components-in-pyRPC"><a href="#Main-Components-in-pyRPC" class="headerlink" title="Main Components in pyRPC"></a>Main Components in pyRPC</h2><h3 id="数据组件和配置组件-com-ypy-pyrpc-model-com-ypy-pyrpc-config"><a href="#数据组件和配置组件-com-ypy-pyrpc-model-com-ypy-pyrpc-config" class="headerlink" title="数据组件和配置组件: com.ypy.pyrpc.model &amp; com.ypy.pyrpc.config"></a>数据组件和配置组件: <code>com.ypy.pyrpc.model</code> &amp; <code>com.ypy.pyrpc.config</code></h3><p>其中定义了 <code>RpcRequest</code>, <code>RpcResponse</code>, <code>ServiceMetaInfo</code>, <code>ServiceRegisterInfo</code> 等基本数据类型.</p>
<p>以及RPC框架的配置数据类型 (<code>RpcConfig</code> and <code>RpcConfig.RegistryConfig</code>) 和一个用于读取配置文件的工具类 (<code>RpcConfigReader</code>).</p>
<p>本框架的配置信息可以写入<code>resources/application.properties</code>, 完整的配置信息如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pyrpc.serverHost=127.0.0.1</span><br><span class="line">pyrpc.serverPort=8081</span><br><span class="line">pyrpc.serverType=http || tcp</span><br><span class="line">pyrpc.mock=false || true</span><br><span class="line">pyrpc.registry.registry=no || etcd</span><br><span class="line">pyrpc.registry.addr=http://127.0.0.1:2375</span><br><span class="line">pyrpc.registry.username=xxx</span><br><span class="line">pyrpc.registry.password=yyy</span><br><span class="line">pyrpc.registry.timeout=10000</span><br><span class="line">pyrpc.serializer=jdk || json || kryo</span><br><span class="line">pyrpc.loadbalancer=round-robin || random || consistent-hash</span><br><span class="line">pyrpc.retry=no || fixed-interval</span><br><span class="line">pyrpc.tolerance=fail-fast || fail-safe</span><br></pre></td></tr></table></figure>

<p><em>*其中 || 分割了可供选择的默认实现类的 key</em></p>
<p>在 <code>resources/META-INF/prrpc/</code> 中, 有 <code>custom/</code> 和 <code>system/</code> 两个目录, 其中 <code>system/</code> 中的文件如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.ypy.pyrpc.spi.loadbalancer.Loadbalancer</span><br><span class="line">com.ypy.pyrpc.spi.registry.Registry</span><br><span class="line">com.ypy.pyrpc.spi.retry.Retry</span><br><span class="line">com.ypy.pyrpc.spi.serializer.Serializer</span><br><span class="line">com.ypy.pyrpc.spi.tolerance.Tolerance</span><br></pre></td></tr></table></figure>

<p>分别对应了提供 SPI 自定义功能实现类的接口名, 在相对应的文件内, 可以写入功能实现类以及其对应的 key. 框架中的默认实现类以及 key 如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">round-robin=com.ypy.pyrpc.spi.loadbalancer.impl.RoundRobinLoadbalancer</span><br><span class="line">random=com.ypy.pyrpc.spi.loadbalancer.impl.RandomLoadbalancer</span><br><span class="line">consistent-hash=com.ypy.pyrpc.spi.loadbalancer.impl.ConsistentHashLoadbalancer</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">no=com.ypy.pyrpc.spi.registry.impl.NoRegistry</span><br><span class="line">etcd=com.ypy.pyrpc.spi.registry.impl.EtcdRegistry</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">no=com.ypy.pyrpc.spi.retry.impl.NoRetry</span><br><span class="line">fixed-interval=com.ypy.pyrpc.spi.retry.impl.FixedIntervalRetry</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jdk=com.ypy.pyrpc.spi.serializer.impl.JdkSerializer</span><br><span class="line">json=com.ypy.pyrpc.spi.serializer.impl.JsonSerializer</span><br><span class="line">kryo=com.ypy.pyrpc.spi.serializer.impl.KryoSerializer</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fail-fast=com.ypy.pyrpc.spi.tolerance.impl.FailFastTolerance</span><br><span class="line">fail-safe=com.ypy.pyrpc.spi.tolerance.impl.FailSafeTolerance</span><br></pre></td></tr></table></figure>

<h3 id="启动组件-com-ypy-pyrpc-bootstrap"><a href="#启动组件-com-ypy-pyrpc-bootstrap" class="headerlink" title="启动组件 com.ypy.pyrpc.bootstrap"></a>启动组件 <code>com.ypy.pyrpc.bootstrap</code></h3><p><strong>:star:Consumer 启动类 <code>ConsumerBootstrap</code></strong></p>
<p>帮助 Consumer 初始化, 其基本逻辑是调用 <code>com.ypy.pyrpc.app.RpcApplication</code>, 来完成对配置信息的读取. 本质上只是对 <code>com.ypy.pyrpc.app.RpcApplication</code> 进行了一层封装, 规范了代码结构.</p>
<p><strong>:star:Provider 启动类 <code>ProviderBoostrap</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProviderBootstrap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(List&lt;ServiceRegisterInfo&gt; serviceRegisterInfoList)</span> &#123;</span><br><span class="line">        RpcApplication.init();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RpcConfig</span> <span class="variable">rpcConfig</span> <span class="operator">=</span> RpcApplication.getRpcConfig();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ServiceRegisterInfo&lt;?&gt; serviceRegisterInfo : serviceRegisterInfoList) &#123;</span><br><span class="line">            RpcLocalRegistry.register(serviceRegisterInfo.getServiceInterfaceName(), serviceRegisterInfo.getServiceImplClass());</span><br><span class="line"></span><br><span class="line">            RpcConfig.<span class="type">RegistryConfig</span> <span class="variable">registryConfig</span> <span class="operator">=</span> rpcConfig.getRegistryConfig();</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> RegistryFactory.getInstance(registryConfig.getRegistry());</span><br><span class="line">            <span class="type">ServiceMetaInfo</span> <span class="variable">serviceMetaInfo</span> <span class="operator">=</span> ServiceMetaInfo.builder()</span><br><span class="line">                    .serviceName(serviceRegisterInfo.getServiceInterfaceName())</span><br><span class="line">                    .serviceVersion(RpcConstant.DEFAULT_SERVICE_VERSION) <span class="comment">// todo</span></span><br><span class="line">                    .serviceHost(rpcConfig.getServerHost())</span><br><span class="line">                    .servicePost(rpcConfig.getServerPort())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                registry.register(serviceMetaInfo);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(serviceRegisterInfo.getServiceInterfaceName() + <span class="string">&quot; register failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">RpcServer</span> <span class="variable">rpcServer</span> <span class="operator">=</span> RpcServerFactory.getInstance(RpcApplication.getRpcConfig().getServerType());</span><br><span class="line">        rpcServer.start(rpcConfig.getServerPort());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>RpcApplication.init()</code> 初始化 RPC 框架, 读取配置信息</li>
<li>把 <code>serviceRegisterInfoList</code> 中的服务注册到本地注册中心 (<code>RpcLocalRegistry</code>)</li>
<li>根据全局配置, 通过注册中心代理工厂 (<code>RegistryFactory</code>) 获取相对应的注册中心对象, 把服务写入注册中心</li>
<li>开启PRC Web 服务器, 在相应的端口专门处理RPC请求</li>
</ul>
<p><em>注意: 把服务注册到本地和把服务注册到注册中心是不同的</em></p>
<ul>
<li>本地注册: 把服务接口信息和服务实现类以单例模式存入 <code>RpcLocalRegistry</code>, 方便处理RPC请求时调用</li>
<li>注册中心: 把服务的信息 (<code>com.ypy.pyrpc.model.ServiceMetaInfo</code>, 主要包含服务名和服务提供者的地址) 存入一个键值型数据库 (例如 ETCD 或 Redis), 这个数据库服务是独立与所有 Provider 的, 因此但不同的 Provider 提供不同的服务时, 注册中心充当了一个 “信息集散地”: RPC 框架帮助 Consumer 在注册中心获取服务的地址, 并挑选合适的服务节点; 当允许多个 Provider 提供相同服务时, 可以使用负载均衡减少服务器压力</li>
</ul>
<h3 id="全局组件-com-ypy-pyrpc-app"><a href="#全局组件-com-ypy-pyrpc-app" class="headerlink" title="全局组件 com.ypy.pyrpc.app"></a>全局组件 <code>com.ypy.pyrpc.app</code></h3><p><strong>:star:RPC初始化工具类<code>RpcApplication</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcApplication</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> RpcConfig rpcConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * init RpcConfig</span></span><br><span class="line"><span class="comment">     * and Registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newRpcConfig</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(RpcConfig newRpcConfig)</span> &#123;</span><br><span class="line">        <span class="comment">// config</span></span><br><span class="line">        rpcConfig = newRpcConfig;</span><br><span class="line">        log.info(<span class="string">&quot;RpcApplication initialized with config: &#123;&#125;&quot;</span>, rpcConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// registry</span></span><br><span class="line">        RpcConfig.<span class="type">RegistryConfig</span> <span class="variable">registryConfig</span> <span class="operator">=</span> rpcConfig.getRegistryConfig();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> RegistryFactory.getInstance(registryConfig.getRegistry());</span><br><span class="line">        registry.init(registryConfig);</span><br><span class="line">        log.info(<span class="string">&quot;Registry initialized with config: &#123;&#125;&quot;</span>, registryConfig);</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(registry::destroy));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        RpcConfig newRpcConfig;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            newRpcConfig = RpcConfigReader.loadConfig(RpcConstant.DEFAULT_CONFIG_PREFIX);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Failed to load configuration file. Using default config.&quot;</span>, e);</span><br><span class="line">            newRpcConfig = <span class="keyword">new</span> <span class="title class_">RpcConfig</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        init(newRpcConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RpcConfig <span class="title function_">getRpcConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rpcConfig == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (RpcApplication.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rpcConfig == <span class="literal">null</span>) init();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rpcConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工具类, 是RPC框架初始化的公共逻辑, 其中都是静态方法和静态成员变量. 维护了一个静态的 <code>RpcConfig</code> 实例, 它包含了 RPC 的全部配置信息. 代码中使用工具类 <code>com.ypy.pyrpc.config.RpcConfigReader</code> 中的静态方法<code>loadConfig</code> 读取程序员在项目 <code>/resourses/application.properties</code> 中写的配置信息. </p>
<p><strong>:star:本地注册中心 <code>RpcLocalRegistry</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcLocalRegistry</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Class&lt;?&gt;&gt; registeredServiceImpl = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String serviceName, Class&lt;?&gt; serviceImpl)</span> &#123;</span><br><span class="line">        registeredServiceImpl.put(serviceName, serviceImpl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getServiceImpl(String serviceName) &#123;</span><br><span class="line">        <span class="keyword">return</span> registeredServiceImpl.get(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeService</span><span class="params">(String serviceName)</span> &#123;</span><br><span class="line">        registeredServiceImpl.remove(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工具类, 维护了一个静态的 <code>ConcurrentHashMap&lt;String, Class&lt;?&gt;&gt;</code> 用于存储 Provider 提供的服务名和对应实现类的Class类</p>
<h3 id="代理组件-com-ypy-pyrpc-proxy"><a href="#代理组件-com-ypy-pyrpc-proxy" class="headerlink" title="代理组件 com.ypy.pyrpc.proxy"></a>代理组件 <code>com.ypy.pyrpc.proxy</code></h3><p>这一部分是 Consumer 发送 RPC 请求的核心</p>
<p><strong>:star:消费者服务代理 <code>ServiceProxy</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> method.getDeclaringClass().getName();</span><br><span class="line">        <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> RpcRequest.builder()</span><br><span class="line">                .serviceName(serviceName)</span><br><span class="line">                .methodName(method.getName())</span><br><span class="line">                .parameterTypes(method.getParameterTypes())</span><br><span class="line">                .args(args)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> RegistryFactory.getInstance(RpcApplication.getRpcConfig().getRegistryConfig().getRegistry());</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceNameVer</span> <span class="operator">=</span> ServiceMetaInfo.serviceNameVer(serviceName, RpcConstant.DEFAULT_SERVICE_VERSION);</span><br><span class="line">        List&lt;ServiceMetaInfo&gt; serviceMetaInfoList = registry.serviceDiscovery(serviceNameVer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Loadbalancer</span> <span class="variable">loadbalancer</span> <span class="operator">=</span> LoadbalancerFactory.getInstance(RpcApplication.getRpcConfig().getLoadbalancer());</span><br><span class="line">        Map&lt;String, Object&gt; context = Map.of(<span class="string">&quot;serviceNameVer&quot;</span>, serviceNameVer);</span><br><span class="line">        <span class="type">ServiceMetaInfo</span> <span class="variable">serviceMetaInfo</span> <span class="operator">=</span> loadbalancer.select(serviceMetaInfoList, context);</span><br><span class="line"></span><br><span class="line">        <span class="type">RpcClient</span> <span class="variable">rpcClient</span> <span class="operator">=</span> RpcClientFactory.getInstance(RpcApplication.getRpcConfig().getServerType());</span><br><span class="line">        RpcResponse rpcResponse;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Retry</span> <span class="variable">retry</span> <span class="operator">=</span> RetryFactory.getInstance(RpcApplication.getRpcConfig().getRetry());</span><br><span class="line">            rpcResponse = retry.retry(() -&gt; rpcClient.request(rpcRequest, serviceMetaInfo));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">Tolerance</span> <span class="variable">tolerance</span> <span class="operator">=</span> ToleranceFactory.getInstance(RpcApplication.getRpcConfig().getTolerance());</span><br><span class="line">            rpcResponse = tolerance.tolerate(e, context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rpcResponse.getData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类可以说是为 Consumer 发送RPC请求的核心, 代码的主要逻辑是:</p>
<ul>
<li>把由参数获取的服务接口名, 服务方法名, 参数类型及参数封装进入<code>rpcRequest</code></li>
<li>根据全局静态配置信息获取注册中心 (<code>registry</code>) 并通过注册中心根据服务名和版本信息发现服务</li>
<li>根据全局静态配置信息获取负载均衡器 (<code>loadbalancer</code>) 并通过负载均衡器选择适合的服务 Provider 节点</li>
<li>使用 <code>RpcClient.request()</code> 静态方法发送 RPC 请求 (这里的逻辑在 RPC Server 部分解释)</li>
<li>根据全局静态配置信息获取重试和容错器, 在出现问题进行相应的处理步骤</li>
<li>获得 <code>rpcResonse</code> 返回其 <code>data</code> 部分</li>
</ul>
<p><strong>:star:Mock服务代理 <code>MockServiceProxy</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MockServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Class&lt;?&gt; methodReturnType = method.getReturnType();</span><br><span class="line">        log.info(<span class="string">&quot;mock invoke &#123;&#125;&quot;</span>, method.getName());</span><br><span class="line">        <span class="keyword">return</span> getDefaultObject(methodReturnType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">getDefaultObject</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">        <span class="comment">// 8 primitive type</span></span><br><span class="line">        <span class="keyword">if</span> (type == <span class="type">boolean</span>.class || type == Boolean.class) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="type">byte</span>.class || type == Byte.class) <span class="keyword">return</span> (<span class="type">byte</span>) <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="type">short</span>.class || type == Short.class) <span class="keyword">return</span> (<span class="type">short</span>) <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="type">char</span>.class || type == Character.class) <span class="keyword">return</span> (<span class="type">char</span>) <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="type">int</span>.class || type == Integer.class) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="type">long</span>.class || type == Long.class) <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="type">float</span>.class || type == Float.class) <span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="type">double</span>.class || type == Double.class) <span class="keyword">return</span> <span class="number">0.0d</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// handle common type</span></span><br><span class="line">        <span class="keyword">if</span> (type == String.class) <span class="keyword">return</span> <span class="string">&quot;&lt;mock&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == List.class) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        <span class="keyword">if</span> (type == Map.class) <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        <span class="keyword">if</span> (type == Set.class) <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// handle self-defined class</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> type.getDeclaredConstructor().newInstance();</span><br><span class="line">            Field[] fields = type.getDeclaredFields();</span><br><span class="line">            <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                Class&lt;?&gt; fieldType = field.getType();</span><br><span class="line">                field.set(instance, getDefaultObject(fieldType)); <span class="comment">// recursion</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Failed to create mock object for type: &#123;&#125;&quot;</span>, type.getName(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为开发者提供生成假数据的服务代理, 当 Consumer 开发者在不存在 Provider 的情况下, 也能调用假服务, 获取假数据</p>
<p><strong>:star:代理服务工厂 <code>ServiceProxyFactory</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceProxyFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class&lt;T&gt; serviceInterface)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (RpcApplication.getRpcConfig().isMock()) <span class="keyword">return</span> getMockProxy(serviceInterface);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(</span><br><span class="line">                serviceInterface.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;serviceInterface&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ServiceProxy</span>()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getMockProxy</span><span class="params">(Class&lt;T&gt; serviceInterface)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(</span><br><span class="line">                serviceInterface.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;serviceInterface&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">MockServiceProxy</span>()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Proxy.newProxyInstance</code> 是 JDK 提供的动态代理工具方法, 它需要三个参数: <ul>
<li><code>ClassLoader</code>: 用于加载代理类的类加载器</li>
<li><code>Class&lt;?&gt;[]</code>: 代理类需要实现的接口列表</li>
<li><code>InvocationHandler</code>: 代理类的调用处理器, 负责拦截方法调用并执行自定义逻辑</li>
</ul>
</li>
<li>在这里, <code>ServiceProxy</code> 和 <code>MockServiceProxy</code> 都实现了 <code>InvocationHandler</code> 接口, 分别用于处理真实的 RPC 调用和 Mock 调用</li>
</ul>
<h3 id="服务器组件-com-ypy-pyrpc-server"><a href="#服务器组件-com-ypy-pyrpc-server" class="headerlink" title="服务器组件 com.ypy.pyrpc.server"></a>服务器组件 <code>com.ypy.pyrpc.server</code></h3><p>这一部分是 Provider 处理 RPC 请求的重点, 也是 RPC 通信的重点. 该包中有两个重要的接口: <code>RpcClient</code> 和 <code>RpcServer</code>. </p>
<p><code>RpcClient</code> 只有一个方法 <code>RpcResponse request(RpcRequest rpcRequest, ServiceMetaInfo serviceMetaInfo) throws Exception;</code>. 它是发送 RPC 请求的核心. 注意, 这里的发送请求不是 <code>ServiceProxy</code> 的普通业务逻辑. 这里的主要是要实现序列化&#x2F;反序列化, 以及使用TCP协议发送请求. </p>
<p><code>RpcServer</code> 也只有一个方法 <code>void start(int port);</code>. 它.帮助 Provider 在相应端口构造 Web 服务, 并处理 RPC 请求.</p>
<p>同时, 它们都有各自对应的工厂类 (<code>RpcClientFactory</code> &amp; <code>RpcServerFactory</code>), 以 <code>RpcClientFactory</code> 为例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcClientFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, RpcClient&gt; clientMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        clientMap.put(RpcServerTypeKeys.TCP, <span class="keyword">new</span> <span class="title class_">TcpClient</span>());</span><br><span class="line">        clientMap.put(RpcServerTypeKeys.HTTP, <span class="keyword">new</span> <span class="title class_">HttpClient</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RpcClient <span class="title function_">getInstance</span><span class="params">(String implClassKey)</span> &#123; <span class="keyword">return</span> clientMap.get(implClassKey); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们不能每发一次 RPC 请求就 new 一个 <code>TcpClient</code> 或 <code>HttpClient</code> 实现类, 于是我们选择使用工厂模式, 维护一个静态的Map, 存储了对应的 <code>RpcClient</code> 的实现类, 会根据对应的 key 返回相应的实现类. <code>RpcServerFactory</code> 同理. 这样即避免了重复 new 对象, 同时也允许开发者配置自己喜欢的底层通信协议 (TCP or HTTP).</p>
<p>接下来我们主要看看使用 TCP 协议作为底层协议, 是如何实现 <code>RpcClient</code> 和 <code>RpcServer</code> 的:</p>
<h4 id="协议数据结构组件-com-ypy-pyrpc-server-tcp-protocol"><a href="#协议数据结构组件-com-ypy-pyrpc-server-tcp-protocol" class="headerlink" title="协议数据结构组件 com.ypy.pyrpc.server.tcp.protocol"></a>协议数据结构组件 <code>com.ypy.pyrpc.server.tcp.protocol</code></h4><p>这里主要定义了自定义协议的结构 (<code>Protocol</code>):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Protocol</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Header</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">byte</span> magic;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">byte</span> version;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">byte</span> serializer;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">byte</span> type;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">byte</span> status;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> requestId;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> bodyLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Header header;</span><br><span class="line">    <span class="keyword">private</span> T body; <span class="comment">// body: RpcRequest or RpcResponse, will be serialized into bytes</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及其它协议常量以及枚举</p>
<h4 id="TCP-服务器实现组件-com-ypy-pyrpc-server-tcp"><a href="#TCP-服务器实现组件-com-ypy-pyrpc-server-tcp" class="headerlink" title="TCP 服务器实现组件 com.ypy.pyrpc.server.tcp"></a>TCP 服务器实现组件 <code>com.ypy.pyrpc.server.tcp</code></h4><p><strong>:star:TCP 服务器实现 <code>TcpServer</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TcpServer</span> <span class="keyword">implements</span> <span class="title class_">RpcServer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="type">Vertx</span> <span class="variable">vertx</span> <span class="operator">=</span> Vertx.vertx();</span><br><span class="line">        <span class="type">NetServer</span> <span class="variable">server</span> <span class="operator">=</span> vertx.createNetServer();</span><br><span class="line">        server.connectHandler(<span class="keyword">new</span> <span class="title class_">TcpServerHandler</span>());</span><br><span class="line">        server.listen(port, netServerAsyncResult -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (netServerAsyncResult.succeeded()) System.out.println(<span class="string">&quot;TcpServer started on port &quot;</span> + port);</span><br><span class="line">            <span class="keyword">else</span> System.out.println(<span class="string">&quot;TcpServer failed to start on port &quot;</span> + port);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码的首先使用 <code>Vertx</code> 构造一个 Web 服务器: 这里的 <code>vertx</code> 虽然不是<code>static</code> 的, 但是因为整个 <code>TcpServcer</code> 会被以单例的形式存储在工厂类的静态变量中, 并且 <code>start</code> 方法只会在 Provider 初始化中被调用一次, 因此不存在重复实例化对象 (<code>Vertx</code> 实例) 的问题. 也就是说, 整个 Provider 中, 只会存在一个 <code>Vertx</code> 实例. 但是, 这并不影响RPC请求的并发处理, 因为:</p>
<ul>
<li><strong><code>Vert.x</code> 的特性</strong>：<br><code>Vert.x</code> 是一个事件驱动的框架, 它的核心思想是<strong>非阻塞 I&#x2F;O</strong> 和<strong>事件循环</strong>. 当你在 <code>TcpServer</code> 中使用 <code>Vert.x</code> 的 <code>NetServer</code> 时，<code>Vert.x</code> 会自动处理多个并发连接, 并且每个连接的处理是非阻塞的. 这意味着: <ul>
<li>多个 Consumer 发送的请求会被 <code>Vert.x</code> 并发处理，而不是顺次处理. </li>
<li><code>Vert.x</code> 的事件循环机制会确保高并发请求的高效处理.</li>
</ul>
</li>
<li><strong>Provider 中的 <code>RpcServer</code> 实例</strong>：<br>在 Provider 中只启动了一个 <code>RpcServer</code> 实例 (例如 <code>TcpServer</code>), 但由于 <code>Vert.x</code> 的异步和非阻塞特性, 这个实例可以同时处理多个 Consumer 的请求. 每个请求都会由 <code>Vert.x</code> 的事件循环分配到不同的线程 (或事件循环线程) 中处理.</li>
</ul>
<p>最后, 使用 <code>.connectHandler()</code> 方法绑定处理器.</p>
<p><strong>:star:TCP 处理器 <code>TcpServerHandler</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TcpServerHandler</span> <span class="keyword">implements</span> <span class="title class_">Handler</span>&lt;NetSocket&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(NetSocket netSocket)</span> &#123;</span><br><span class="line">        <span class="type">TcpBufferHandlerWrapper</span> <span class="variable">bufferHandlerWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TcpBufferHandlerWrapper</span>(buffer -&gt; &#123;</span><br><span class="line">            Protocol&lt;RpcRequest&gt; protocol;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                protocol = (Protocol&lt;RpcRequest&gt;) ProtocolUtils.decode(buffer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Decode Err&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> protocol.getBody();</span><br><span class="line">            <span class="type">RpcResponse</span> <span class="variable">rpcResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcResponse</span>();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class&lt;?&gt; serviceImpl = RpcLocalRegistry.getServiceImpl(rpcRequest.getServiceName());</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> serviceImpl.getMethod(rpcRequest.getMethodName(), rpcRequest.getParameterTypes());</span><br><span class="line">                <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(serviceImpl.newInstance(), rpcRequest.getArgs());</span><br><span class="line"></span><br><span class="line">                rpcResponse.setData(result);</span><br><span class="line">                rpcResponse.setDataType(method.getReturnType());</span><br><span class="line">                rpcResponse.setMsg(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                rpcResponse.setMsg(e.getMessage());</span><br><span class="line">                rpcResponse.setException(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Protocol.<span class="type">Header</span> <span class="variable">header</span> <span class="operator">=</span> protocol.getHeader();</span><br><span class="line">            header.setType(ProtocolTypeEnum.RESPONSE.getCode());</span><br><span class="line">            Protocol&lt;RpcResponse&gt; responseProtocol = <span class="keyword">new</span> <span class="title class_">Protocol</span>&lt;&gt;(header, rpcResponse);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Buffer</span> <span class="variable">encodeBuffer</span> <span class="operator">=</span> ProtocolUtils.encode(responseProtocol);</span><br><span class="line">                netSocket.write(encodeBuffer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Encode Err&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        netSocket.handler(bufferHandlerWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Handler 中, <code>netSocket.handler()</code> 传入一个 <code>Handler&lt;Buffer&gt;</code> 对象, 用于处理通信的字节流.</p>
<p>使用 <code>TcpBufferHandlerWrapper</code> 包裹, 以解决半包&#x2F;粘包问题.</p>
<p>处理的主体逻辑是:</p>
<ul>
<li>通过全局配置获取序列化器, 使用序列化器将传入的 buffer 反序列化成 <code>Protocol&lt;RpcRequest&gt; requestProtocol</code> , 获取其 <code>body</code>, 就是 <code>rpcRequest</code></li>
<li>在 <code>rpcRequest</code> 中获取要调用服务的信息 (服务接口名, 方法名, 参数类型及参数列表), 通过 <code>RpcLocalRegistry</code> 获取服务实现类的 Class 对象, 并使用 <code>invoke</code> 调用获取方法返回结果 <code>result</code></li>
<li>将结果封装进入 <code>rpcResponse</code>, 将 <code>rpcResponse</code> 封装进入 <code>Protocol&lt;RpcResponse&gt; responseProtocol</code></li>
<li>通过之前的序列化器序列化 <code>responseProtocol</code>, 并使用 <code>netSocket.write(encodeBuffer);</code> 将 buffer 写入socket</li>
</ul>
<p><strong>:star:TCP 客户端实现 <code>TcpClient</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TcpClient</span> <span class="keyword">implements</span> <span class="title class_">RpcClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Vertx</span> <span class="variable">vertx</span> <span class="operator">=</span> Vertx.vertx(); <span class="comment">// signal instance</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">NetClient</span> <span class="variable">netClient</span> <span class="operator">=</span> vertx.createNetClient(<span class="keyword">new</span> <span class="title class_">NetClientOptions</span>()); <span class="comment">// signal instance</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RpcResponse <span class="title function_">request</span><span class="params">(RpcRequest rpcRequest, ServiceMetaInfo serviceMetaInfo)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;RpcResponse&gt; responseCompletableFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        netClient.connect(</span><br><span class="line">                serviceMetaInfo.getServicePost(),</span><br><span class="line">                serviceMetaInfo.getServiceHost(),</span><br><span class="line">                netSocketAsyncResult -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!netSocketAsyncResult.succeeded()) &#123;</span><br><span class="line">                        System.err.println(netSocketAsyncResult.cause().getMessage());</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">NetSocket</span> <span class="variable">netSocket</span> <span class="operator">=</span> netSocketAsyncResult.result();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// make date</span></span><br><span class="line">                    Protocol.<span class="type">Header</span> <span class="variable">header</span> <span class="operator">=</span> Protocol.Header.builder()</span><br><span class="line">                            .magic(ProtocolConst.MAGIC)</span><br><span class="line">                            .version(ProtocolConst.VERSION)</span><br><span class="line">                            .serializer(ProtocolSerializerEnum.getByKey(RpcApplication.getRpcConfig().getSerializer()).getCode())</span><br><span class="line">                            .type(ProtocolTypeEnum.REQUEST.getCode())</span><br><span class="line">                            .requestId(IdUtil.getSnowflakeNextId())</span><br><span class="line">                            .build();</span><br><span class="line">                    Protocol&lt;RpcRequest&gt; rpcRequestProtocol = <span class="keyword">new</span> <span class="title class_">Protocol</span>&lt;&gt;(header, rpcRequest);</span><br><span class="line">                    rpcRequestProtocol.setHeader(header);</span><br><span class="line">                    rpcRequestProtocol.setBody(rpcRequest);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// send data</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ProtocolUtils.encode(rpcRequestProtocol);</span><br><span class="line">                        netSocket.write(buffer);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Encode failed&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// get response data</span></span><br><span class="line">                    <span class="type">TcpBufferHandlerWrapper</span> <span class="variable">bufferHandlerWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TcpBufferHandlerWrapper</span>(buffer -&gt; &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Protocol&lt;RpcResponse&gt; responseProtocol =</span><br><span class="line">                                    (Protocol&lt;RpcResponse&gt;) ProtocolUtils.decode(buffer);</span><br><span class="line">                            responseCompletableFuture.complete(responseProtocol.getBody());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Decode failed&quot;</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    netSocket.handler(bufferHandlerWrapper);</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">RpcResponse</span> <span class="variable">rpcResponse</span> <span class="operator">=</span> responseCompletableFuture.get();</span><br><span class="line">        <span class="keyword">return</span> rpcResponse;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TcpClient</code> 的实例被存储在工厂类中, 但是, 由于 Consumer 要多次调用 <code>request</code> 方法, 因此选择把 <code>Vertx</code> 和 <code>NetClient</code> 实例作为静态变量, 避免每次调用 <code>request</code> 的时候都创建连接.</p>
<p>将以上的 <code>RpcServer</code> 和 <code>RpcClient</code> 分开构建的原因是: 为了满足一个节点作为 Consumer 的同时也提供服务, 作为 Provider. </p>
<p><strong>:star:解决半包粘包处理器 <code>TcpBufferHandlerWrapper</code></strong></p>
<p>为了解决 TCP 传输中的半包粘包问题, 构造一个处理器, 它实现并增强 <code>Handler&lt;Buffer&gt;</code> 接口. 这种做法是设计模式中的 <strong>装饰者模式</strong>, 使用 <code>RecordParser</code> 对原有的 <code>Buffer</code> 处理器的能力进行增强. 装饰者模式可以简单理解为给对象穿装备, 增强对象的能力. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TcpBufferHandlerWrapper</span> <span class="keyword">implements</span> <span class="title class_">Handler</span>&lt;Buffer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RecordParser recordParser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RecordParser <span class="title function_">initRecordParser</span><span class="params">(Handler&lt;Buffer&gt; bufferHandler)</span> &#123;</span><br><span class="line">        <span class="type">RecordParser</span> <span class="variable">parser</span> <span class="operator">=</span> RecordParser.newFixed(ProtocolConst.HEADER_LENGTH);</span><br><span class="line">        parser.setOutput(<span class="keyword">new</span> <span class="title class_">Handler</span>&lt;Buffer&gt;() &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bodyLength</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="type">Buffer</span> <span class="variable">resultBuffer</span> <span class="operator">=</span> Buffer.buffer();</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Buffer buffer)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (-<span class="number">1</span> == bodyLength) &#123;</span><br><span class="line">                    <span class="comment">// 1. 首先解析 Header（固定长度 17 字节）</span></span><br><span class="line">                    bodyLength = buffer.getInt(<span class="number">13</span>); <span class="comment">// 获取 Body 的长度，假设Header的索引 13..=16 字节表示 BodyLength</span></span><br><span class="line">                    parser.fixedSizeMode(bodyLength); <span class="comment">// 根据Body的长度设置接下来的解析模式</span></span><br><span class="line">                    resultBuffer.appendBuffer(buffer); <span class="comment">// 将Header数据缓存起来</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 2. 接收 Body 数据</span></span><br><span class="line">                    resultBuffer.appendBuffer(buffer); <span class="comment">// 将接收到的Body数据添加到缓存中</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (resultBuffer.length() &gt;= bodyLength + ProtocolConst.HEADER_LENGTH) &#123;</span><br><span class="line">                        bufferHandler.handle(resultBuffer); <span class="comment">// 调用外部传入的回调，处理完整的消息</span></span><br><span class="line">                        <span class="comment">// 4. 处理完后，重置状态，准备处理下一个数据包</span></span><br><span class="line">                        parser.fixedSizeMode(ProtocolConst.HEADER_LENGTH);</span><br><span class="line">                        bodyLength = -<span class="number">1</span>; <span class="comment">// 重置Body长度</span></span><br><span class="line">                        resultBuffer = Buffer.buffer(); <span class="comment">// 重置缓存</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> parser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TcpBufferHandlerWrapper</span><span class="params">(Handler&lt;Buffer&gt; bufferHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.recordParser = initRecordParser(bufferHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Buffer buffer)</span> &#123;</span><br><span class="line">        recordParser.handle(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SPI-组件-com-ypy-pyrpc-spi"><a href="#SPI-组件-com-ypy-pyrpc-spi" class="headerlink" title="SPI 组件 com.ypy.pyrpc.spi"></a>SPI 组件 <code>com.ypy.pyrpc.spi</code></h3><p>**SPI (Service Provider Interface) ** 是一种服务发现机制, 用于在运行时动态加载实现类. 它是 Java 提供的一种标准扩展点机制, 允许框架或库定义接口, 并由第三方提供实现. SPI 的核心思想是 <strong>解耦接口与实现</strong>, 使得应用程序可以在不修改代码的情况下扩展功能. 说白了, 就是SDK中提供一些接口和默认实现类, 当开发者不想使用SDK提供的实现类时, 他们可以自己写一个实现类, 并通过配置让SDK使用自定义的实现类.</p>
<p><strong>:star:SPI导入器<code>SpiLoader</code>​</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpiLoader</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * store the class that has been load, &#123;interfaceName: &#123;implClassKey: implClass&#125;&#125;</span></span><br><span class="line"><span class="comment">     * className means full name, e.g. com.ypy.pyrpc.spi.serializer.Serializer</span></span><br><span class="line"><span class="comment">     * classKey means a short key, representing some implClass, e.g. jdk=JdkSerializer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Map&lt;String, Class&lt;?&gt;&gt;&gt; spiMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cache of instance, avoid repeat &quot;new&quot;</span></span><br><span class="line"><span class="comment">     * &#123;implClassName: implClassInstance&#125;</span></span><br><span class="line"><span class="comment">     * full-name, not a key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Object&gt; implClassInstanceCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Object&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RPC_SYSTEM_SPI_DIR</span> <span class="operator">=</span> <span class="string">&quot;META-INF/pyrpc/system/&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RPC_CUSTOM_SPI_DIR</span> <span class="operator">=</span> <span class="string">&quot;META-INF/pyrpc/custom/&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] SCAN_DIRS = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;RPC_SYSTEM_SPI_DIR, RPC_CUSTOM_SPI_DIR&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Class&lt;?&gt;&gt; load(Class&lt;?&gt; interfaceClass) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">interfaceName</span> <span class="operator">=</span> interfaceClass.getName();</span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; implKey2implClassMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">// &#123;implClassKey: implClass&#125;</span></span><br><span class="line">        <span class="keyword">for</span> (String dir : SCAN_DIRS) &#123;</span><br><span class="line">            List&lt;URL&gt; resources = ResourceUtil.getResources(dir + interfaceName);</span><br><span class="line">            <span class="keyword">for</span> (URL resource : resources) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(resource.openStream());</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(isr);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        String[] split = line.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (split.length == <span class="number">2</span>) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">implClassKey</span> <span class="operator">=</span> split[<span class="number">0</span>];</span><br><span class="line">                            <span class="type">String</span> <span class="variable">implClassName</span> <span class="operator">=</span> split[<span class="number">1</span>];</span><br><span class="line">                            implKey2implClassMap.put(implClassKey, Class.forName(implClassName));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;spi resource load error&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        spiMap.put(interfaceName, implKey2implClassMap);</span><br><span class="line">        <span class="keyword">return</span> implKey2implClassMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getInstance</span><span class="params">(Class&lt;T&gt; interfaceClass, String implClassKey)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">interfaceName</span> <span class="operator">=</span> interfaceClass.getName();</span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; implKey2implClassMap = spiMap.get(interfaceName);</span><br><span class="line">        <span class="keyword">if</span> (implKey2implClassMap == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Interface &quot;</span> + interfaceName + <span class="string">&quot; has no implement classes&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!implKey2implClassMap.containsKey(implClassKey)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Interface &quot;</span> + interfaceName + <span class="string">&quot; has no implement &quot;</span> + implClassKey);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; implClass = implKey2implClassMap.get(implClassKey);</span><br><span class="line">        <span class="keyword">if</span> (!implClassInstanceCache.containsKey(implClass.getName())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                implClassInstanceCache.put(implClass.getName(), implClass.newInstance());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Write &quot;</span> + implClass.getName() + <span class="string">&quot; into cache failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) implClassInstanceCache.get(implClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用两个<code>ConcurrentHashMap</code>存贮功能接口和实现类的信息, 并引入缓存机制:</p>
<ul>
<li><code>spiMap</code> 的存储模式是: <code>&#123;interfaceName: &#123;implClassKey: implClass&#125;&#125;</code>, 例如 <code>&#123;&quot;Registry&quot; : &#123;&quot;jdk&quot;: Class&lt;JdkRegistry&gt;, &quot;json&quot;: Class&lt;JsonRegistry&gt;&#125;&#125;</code></li>
<li><code>implClassInstanceCache</code> 的存储模式是: <code>&#123;implClassName: implClassInstance&#125;</code>, 例如 <code>&#123;&quot;JdkRegistry&quot;: JdkRegistry&#125;</code>. 作为对象缓存, 避免重复new对象</li>
</ul>
<p>使用SPI机制, 为以下四个功能模块提供了可定制化选择: 1) 注册中心; 2) 序列化器; 3) 负载均衡器; 4) 重试和容错器. 它们有对应的工厂类, 例如</p>
<p><strong>:stars:<code>RegistryFactory</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegistryFactory</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123; SpiLoader.load(Registry.class); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Registry <span class="title function_">getInstance</span><span class="params">(String implClassKey)</span> &#123; <span class="keyword">return</span> SpiLoader.getInstance(Registry.class, implClassKey); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当项目加载时, 工厂类的 <code>static</code> 部分会调用 <code>loader</code> 方法, 将默认实现类和用户实现类加入 <code>SpiLoader</code> 中的字典容器, 同时, 由于是先载入框架默认实现类后载入用户自定义实现类, 因此用户自定义的key会覆盖框架默认的key, 这样是更加合理的. </p>
<p>下面分别介绍一下框架中的默认实现类.</p>
<h4 id="序列化器组件-com-ypy-pyrpc-spi-serializer"><a href="#序列化器组件-com-ypy-pyrpc-spi-serializer" class="headerlink" title="序列化器组件 com.ypy.pyrpc.spi.serializer"></a>序列化器组件 <code>com.ypy.pyrpc.spi.serializer</code></h4><p><strong>:star:<code>Serializer</code> 接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line">    &lt;T&gt; <span class="type">byte</span>[] serialize(T obj) <span class="keyword">throws</span> IOException;</span><br><span class="line">    &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] data, Class&lt;T&gt; type)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>框架提供的默认实现类在 <code>impl</code> 包中, 有 JDK, JSON, KRYO 三种序列化器. </p>
<h4 id="注册中心组件-com-ypy-pyrpc-spi-registry"><a href="#注册中心组件-com-ypy-pyrpc-spi-registry" class="headerlink" title="注册中心组件 com.ypy.pyrpc.spi.registry"></a>注册中心组件 <code>com.ypy.pyrpc.spi.registry</code></h4><p><strong>:smile:形象的例子</strong></p>
<p>食客 - 点餐平台 (美团) - 饭馆: 食客 &#x3D; Consumer, 美团 &#x3D; 注册中心, 餐馆 &#x3D; Provider. </p>
<p>食客从美团不是去吃菜 (调用服务), 而是获取餐馆和菜品信息, 然后再去餐馆吃菜 (发起 RPC 请求). </p>
<p>餐馆 (Provider) 要先做菜 (把提供的服务存入本地注册中心 <code>RpcLocalRegistry</code>) 再把相应的菜品信息存入美团 (把提供的服务的信息提交给 <code>Registry</code>, <code>Registry</code> 把信息存入 ETCD), 这样顾客才能发现菜品. </p>
<p>所谓服务发现缓存, 实际就是, 当一个食客经常去某餐馆吃饭, 他去多了, 也就没有必要次次都去到美团上查看关于餐馆的信息 (例如在哪里, 有哪些菜品). </p>
<p><strong>:star:<code>Registry</code>​ 接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Registry</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * initialize registry for both PROVIDER and CONSUMER</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registryConfig</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(RpcConfig.RegistryConfig registryConfig)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * help PROVIDER to register their service (info) into registry</span></span><br><span class="line"><span class="comment">     * and these services should also be registered and managed by LocalRegistry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceMetaInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(ServiceMetaInfo serviceMetaInfo)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * help PROVIDER to unregister service</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceMetaInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unregister</span><span class="params">(ServiceMetaInfo serviceMetaInfo)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * help CONSUMER to search a group of service meta info by ServiceNameVersion</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceNameVer: &quot;serviceName:serviceVersion&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;ServiceMetaInfo&gt; <span class="title function_">serviceDiscovery</span><span class="params">(String serviceNameVer)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * when a PROVIDER offline, clear correlative service info it provided in registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * send update message to registry, confirming PROVIDED alive</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">heartBeat</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * help CONSUMER to watch PROVIDER, when a Provider offline (actively or passively), it will update local cache info of CONSUMER</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fullRegistryServiceKey: /[RPC_ROOT_PATH]/[ServiceName]:[ServiceVersion]/[ServiceAddr]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">watch</span><span class="params">(String fullRegistryServiceKey, String serviceNameVer)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册中心接口有六个方法, 分别是注册中心初始化, 服务注册, 服务注销, 服务发现, 节点关闭, 心跳检测, 以及节点监视. </p>
<p>在 <code>impl</code> 包中, 提供了 ETCD 的默认实现 (<code>com.ypy.pyrpc.spi.registry.impl.EtcdRegistry</code>), 以及无注册中心的实现 <code>NoRegistry</code>. </p>
<p>实现一个注册中心是一个难点, 我们详细说一下:</p>
<p><strong>:stars:<code>EtcdRegistry</code>​ ETCD 注册中心</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EtcdRegistry</span> <span class="keyword">implements</span> <span class="title class_">Registry</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Client cli;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> KV kvCli;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ETCD_ROOT_PATH</span> <span class="operator">=</span> <span class="string">&quot;/pyrpc/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fullRegistryServiceKey: /pyrpc/com.....UserService:1.0.0/http://127.0.0.1:8080</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * this collection stores data for PROVIDER</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; loaclFullRegistryServiceKeySet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key is serviceNameVersion</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * this collection stores data for CONSUMER, make convenience through cache ServiceNameVer and their MetaInfo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;ServiceMetaInfo&gt;&gt; serviceNameVerCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; watchingNodeKeySet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(RpcConfig.RegistryConfig registryConfig)</span> &#123;</span><br><span class="line">        cli = Client.builder()</span><br><span class="line">                .endpoints(registryConfig.getAddr())</span><br><span class="line">                .connectTimeout(Duration.ofMillis(registryConfig.getTimeout()))</span><br><span class="line">                .build();</span><br><span class="line">        kvCli = cli.getKVClient();</span><br><span class="line">        heartBeat();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(ServiceMetaInfo serviceMetaInfo)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Lease</span> <span class="variable">leaseCli</span> <span class="operator">=</span> cli.getLeaseClient();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">leaseId</span> <span class="operator">=</span> leaseCli.grant(<span class="number">30L</span>).get().getID();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">fullRegistryServiceKey</span> <span class="operator">=</span> ETCD_ROOT_PATH + serviceMetaInfo.getServiceNameVerAddr();</span><br><span class="line">        <span class="type">ByteSequence</span> <span class="variable">k</span> <span class="operator">=</span> ByteSequence.from(fullRegistryServiceKey, StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">ByteSequence</span> <span class="variable">v</span> <span class="operator">=</span> ByteSequence.from(JSONUtil.toJsonStr(serviceMetaInfo), StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        <span class="type">PutOption</span> <span class="variable">putOption</span> <span class="operator">=</span> PutOption.builder().withLeaseId(leaseId).build();</span><br><span class="line">        kvCli.put(k, v, putOption).get();</span><br><span class="line">        loaclFullRegistryServiceKeySet.add(fullRegistryServiceKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregister</span><span class="params">(ServiceMetaInfo serviceMetaInfo)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fullRegistryServiceKey</span> <span class="operator">=</span> ETCD_ROOT_PATH + serviceMetaInfo.getServiceNameVerAddr();</span><br><span class="line">        kvCli.delete(ByteSequence.from(fullRegistryServiceKey, StandardCharsets.UTF_8));</span><br><span class="line">        loaclFullRegistryServiceKeySet.remove(serviceMetaInfo.getServiceNameVerAddr());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceMetaInfo&gt; <span class="title function_">serviceDiscovery</span><span class="params">(String serviceNameVer)</span> &#123;</span><br><span class="line">        List&lt;ServiceMetaInfo&gt; cachedServiceMetaInfos = serviceNameVerCache.get(serviceNameVer);</span><br><span class="line">        <span class="keyword">if</span> (cachedServiceMetaInfos != <span class="literal">null</span>) <span class="keyword">return</span> cachedServiceMetaInfos;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// search in etcd</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">searchPrefix</span> <span class="operator">=</span> ETCD_ROOT_PATH + serviceNameVer + <span class="string">&quot;/&quot;</span>; <span class="comment">// add &quot;/&quot; means search for group</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">GetOption</span> <span class="variable">getOption</span> <span class="operator">=</span> GetOption.builder().isPrefix(<span class="literal">true</span>).build();</span><br><span class="line">            List&lt;KeyValue&gt; kvs = kvCli.get(</span><br><span class="line">                    ByteSequence.from(searchPrefix, StandardCharsets.UTF_8),</span><br><span class="line">                    getOption</span><br><span class="line">            ).get().getKvs();</span><br><span class="line"></span><br><span class="line">            List&lt;ServiceMetaInfo&gt; serviceMetaInfoList = kvs.stream()</span><br><span class="line">                    .map(kv -&gt; &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">fullRegistryServiceKey</span> <span class="operator">=</span> kv.getKey().toString(StandardCharsets.UTF_8);</span><br><span class="line">                        watch(fullRegistryServiceKey, serviceNameVer);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> kv.getValue().toString(StandardCharsets.UTF_8);</span><br><span class="line">                        <span class="keyword">return</span> JSONUtil.toBean(val, ServiceMetaInfo.class);</span><br><span class="line">                    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">            serviceNameVerCache.put(serviceNameVer, serviceMetaInfoList);</span><br><span class="line">            <span class="keyword">return</span> serviceMetaInfoList;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Get service list failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String key : loaclFullRegistryServiceKeySet) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                kvCli.delete(ByteSequence.from(key, StandardCharsets.UTF_8));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(key + <span class="string">&quot;: delete etcd node failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (kvCli != <span class="literal">null</span>) kvCli.close();</span><br><span class="line">        <span class="keyword">if</span> (cli != <span class="literal">null</span>) cli.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Destroy Current Node&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">heartBeat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// every 10 seconds, update lease for all services provided by current Provider</span></span><br><span class="line">        CronUtil.schedule(<span class="string">&quot;*/10 * * * * *&quot;</span>, <span class="keyword">new</span> <span class="title class_">Task</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (String key : loaclFullRegistryServiceKeySet) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        List&lt;KeyValue&gt; kvs = kvCli.get(ByteSequence.from(key, StandardCharsets.UTF_8))</span><br><span class="line">                                .get()</span><br><span class="line">                                .getKvs();</span><br><span class="line">                        <span class="keyword">if</span> (kvs.isEmpty()) <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="type">KeyValue</span> <span class="variable">kv</span> <span class="operator">=</span> kvs.get(<span class="number">0</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> kv.getValue().toString(StandardCharsets.UTF_8);</span><br><span class="line">                        <span class="type">ServiceMetaInfo</span> <span class="variable">serviceMetaInfo</span> <span class="operator">=</span> JSONUtil.toBean(val, ServiceMetaInfo.class);</span><br><span class="line">                        register(serviceMetaInfo);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(key + <span class="string">&quot;: updating lease failed&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        CronUtil.setMatchSecond(<span class="literal">true</span>);</span><br><span class="line">        CronUtil.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">watch</span><span class="params">(String fullRegistryServiceKey, String serviceNameVer)</span> &#123;</span><br><span class="line">        <span class="type">Watch</span> <span class="variable">watchCli</span> <span class="operator">=</span> cli.getWatchClient();</span><br><span class="line">        <span class="keyword">if</span> (watchingNodeKeySet.add(fullRegistryServiceKey)) &#123;</span><br><span class="line">            watchCli.watch(ByteSequence.from(fullRegistryServiceKey, StandardCharsets.UTF_8), watchResponse -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (WatchEvent event : watchResponse.getEvents()) &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (event.getEventType()) &#123;</span><br><span class="line">                        <span class="keyword">case</span> DELETE:</span><br><span class="line">                            serviceNameVerCache.remove(serviceNameVer);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> PUT:</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看成员变量: 由于 <code>EtcdRegistry</code> 实例是被保存在 <code>SpiLoader</code> 中, 因此每次获取实例时并不会重复创建实例, 所以其中的成员变量都不需要设置为 <code>static</code>.</p>
<ul>
<li><code>Client cli</code> 是 <code>jetcd</code> 中, 操作 ETCD 的客户端, <code>jectd</code> 是专门为 Java 操作 ECTD 的 SDK, 相当于 Jedis &#x2F; Redission 之于 Redis</li>
<li><code>kvCli</code> 是由 <code>cli</code> 生成的操作键值对的客户端</li>
<li><code>ETCD_ROOT_PATH</code> 是存储在 ETCD 数据库中本项目的标识前缀, 用来与其它项目区分</li>
<li><code>Set&lt;String&gt; loaclFullRegistryServiceKeySet</code> 是存储本地 (也就是当前 Provider) 中提供的服务信息, 它里面存的是服务的全部信息, 其结构为 <code>/pyrpc/com.....UserService:1.0.0/http://127.0.0.1:8080</code> 即前缀 + 服务接口名 + 版本号 + Provider 地址</li>
<li><code>Map&lt;String, List&lt;ServiceMetaInfo&gt;&gt; serviceNameVerCache</code> 是为 <strong>Consumer</strong> 提供的服务发现缓存, 因为 Consumer 发送 RPC 请求是很频繁的, 我们没有必要每一次都向 ETCD 请求服务信息, 而是选择把对应的信息缓存起来, 这样 Consumer 就可以更加高效的获取服务信息, 再提供信息发送RPC请求了. 由于发现服务是 Consumer 提供服务接口名和版本号, 因此 <code>serviceNameVerCache</code> 的 key 结构为 <code>com.....UserService:1.0.0</code></li>
<li><code>Set&lt;String&gt; watchingNodeKeySet</code> 是为 Consumer 提供的监视机制, 它存储了正在监视的结点, 里面存储的是 <code>fullRegistryServiceKey</code>, 也就是前缀 + 服务接口名 + 版本号 + Provider 地址的全部信息</li>
</ul>
<p>再来看方法实现:</p>
<ul>
<li><code>init</code> 是初始化方法, 包括创建相应的 Java ETCD 客户端</li>
<li><code>register</code> 是服务注册, 主要完成写入信息到 ETDC 和写入信息到本地 <code>loaclFullRegistryServiceKeySet</code></li>
<li><code>serviceDiscovery</code> 是通过服务接口名和版本号来发现服务, 先查看缓存, 缓存没有再向 ETCD 拉取, 同时存入缓存. 存入缓存的服务需要监视其节点, 于是要调用 <code>watch(fullRegistryServiceKey, serviceNameVer);</code> 方法</li>
<li><code>destroy</code> 是 Provider 端的主动下线机制, 当一个 Provider 停机了, 会将情况先行上报给 ETCD 以避免 Consumer 的错误调用</li>
<li><code>heartBeat</code> 是 Provider 端的被动下线机制, 当一个 Provider 因为异常停机, 例如断电, 这时候就无法执行 <code>destroy</code> 了. 心跳检测的原理是 Provider 定时 (10 s) 向注册中心更新一次服务信息, ETCD 则对每一个节点的信息设置一个稍长的过期时间 (30 s). 当 Provider 因为异常停机, 其对应的节点就会因为无法续期而被 ETCD 删除. 因此异常停机造成的影响最多持续 30 s.</li>
<li><code>watch</code> 是为 Consumer 检测 Provider 状态的, 当一个 Provider 下线 (主动或被动), Consumer 就会收到 ETCD 的相应, 并删除对应的服务信息缓存</li>
</ul>
<p>以上的做法维护了: </p>
<ul>
<li>数据一致性: 当某个 Provider 下线了, 注册中心需要即时剔除它的结点服务信息.</li>
<li>性能优化: Consumer 每次都要从注册中心获取服务, 可以使用缓存进行优化. </li>
<li>高可用性: 保证注册中心不会宕机. </li>
<li>高扩展性: 提供不同的注册中心实现类, 并使用 SPI 机制运行用户自定义注册中心实现类.</li>
</ul>
<h4 id="负载均衡组件-com-ypy-pyrpc-spi-loadbalancer"><a href="#负载均衡组件-com-ypy-pyrpc-spi-loadbalancer" class="headerlink" title="负载均衡组件 com.ypy.pyrpc.spi.loadbalancer"></a>负载均衡组件 <code>com.ypy.pyrpc.spi.loadbalancer</code></h4><p>为 Consumer 从众多内容相同但 Provider 不同的服务结点中, 依据某种算法选择恰当的服务节点, 这样可以合理分配 Provider 端的压力. </p>
<p><strong>:stars:<code>Loadbalancer</code> 接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Loadbalancer</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceMetaInfoList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context: Provide additional contextual information for load balancing algorithms to more intelligently select service instances.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ServiceMetaInfo <span class="title function_">select</span><span class="params">(List&lt;ServiceMetaInfo&gt; serviceMetaInfoList, Map&lt;String, Object&gt; context)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用轮询, 随机, 和一致哈希等方法实现了默认的三种序列化器实现</p>
<h4 id="重试和容错组件-com-ypy-pyrpc-spi-retry-com-ypy-pyrpc-spi-tolerance"><a href="#重试和容错组件-com-ypy-pyrpc-spi-retry-com-ypy-pyrpc-spi-tolerance" class="headerlink" title="重试和容错组件 com.ypy.pyrpc.spi.retry &amp; com.ypy.pyrpc.spi.tolerance"></a>重试和容错组件 <code>com.ypy.pyrpc.spi.retry</code> &amp; <code>com.ypy.pyrpc.spi.tolerance</code></h4><p>这一部分只做了简单的实现和占位, 开发者可以使用SPI机制自定义实现</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/01/lang/rust/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/126999663?v=4">
      <meta itemprop="name" content="peiyouyao">
      <meta itemprop="description" content="...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Perry's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/01/lang/rust/" class="post-title-link" itemprop="url">My Rust</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-01 00:00:00" itemprop="dateCreated datePublished" datetime="2024-11-01T00:00:00+00:00">2024-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-17 01:19:24" itemprop="dateModified" datetime="2025-12-17T01:19:24+00:00">2025-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/lang/" itemprop="url" rel="index"><span itemprop="name">lang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="MyRust"><a href="#MyRust" class="headerlink" title="MyRust"></a>MyRust</h1><h2 id="Rust-优秀的签名设计"><a href="#Rust-优秀的签名设计" class="headerlink" title="Rust 优秀的签名设计"></a>Rust 优秀的签名设计</h2><blockquote>
<p>我注意到一个写代码中的问题: </p>
<p>例如 <code>int[] plusOne(int[] arr)</code> 这个函数签名无法确保程序员是在 arr 上原地修改的, 还是把arr clone 了一份</p>
<p>而rust 则可以通过对函数签名的要求明确表示出这一点</p>
<p>例如</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">plus_one</span>(arr: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; <span class="comment">// arr 走出函数便不再可用` </span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">plus_one</span>(arr: &amp;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;` </span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">plus_one</span>(arr: &amp;<span class="keyword">mut</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;)`</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>Rust 函数签名设计的一个核心优势</strong>：<strong>通过函数签名清晰表达了数据的所有权、借用和修改关系</strong>。</p>
<p>在很多语言（如 C++、Java）中，<strong>无法仅通过函数签名来判断</strong>一个数组（或列表）是否是<strong>原地修改的</strong>，<strong>还是克隆了一份新数组</strong>。但在 Rust 中，<strong>函数签名本身就明确了这一点</strong>，因为 Rust 强制要求开发者<strong>显式声明所有权和可变性</strong>。</p>
<p>Rust 三权分立: 所有权, 读权, 写权</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(PartialEq, Eq, Clone, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> val: <span class="type">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> next: <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;ListNode&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(val: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        ListNode &#123; val, next: <span class="literal">None</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add_one_node</span>(head: &amp;<span class="keyword">mut</span> <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;ListNode&gt;&gt;, value: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p</span>: &amp;<span class="keyword">mut</span> <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;ListNode&gt;&gt; = head; <span class="comment">// p 是 head 的可变引用</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(node) = p &#123;</span><br><span class="line">        p = &amp;<span class="keyword">mut</span> node.next; <span class="comment">// 不断向链表尾部移动</span></span><br><span class="line">    &#125;</span><br><span class="line">    *p = <span class="title function_ invoke__">Some</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ListNode::<span class="title function_ invoke__">new</span>(value))); <span class="comment">// 在尾部插入新节点</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">show_list</span>(head: &amp;<span class="type">Option</span>&lt;<span class="type">Box</span>&lt;ListNode&gt;&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p</span>: &amp;<span class="type">Option</span>&lt;<span class="type">Box</span>&lt;ListNode&gt;&gt; = head; <span class="comment">// p 是 &amp;Option&lt;Box&lt;ListNode&gt;&gt;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(node) = p &#123;</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125; -&gt; &quot;</span>, node.val); <span class="comment">// 打印当前节点的值</span></span><br><span class="line">        p = &amp;node.next; <span class="comment">// 向下一个节点移动，p 的类型是 &amp;Option&lt;Box&lt;ListNode&gt;&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">head</span>: <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;ListNode&gt;&gt; = <span class="title function_ invoke__">Some</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ListNode::<span class="title function_ invoke__">new</span>(<span class="number">1</span>)));</span><br><span class="line">    <span class="title function_ invoke__">add_one_node</span>(&amp;<span class="keyword">mut</span> head, <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">add_one_node</span>(&amp;<span class="keyword">mut</span> head, <span class="number">3</span>);</span><br><span class="line">    <span class="title function_ invoke__">add_one_node</span>(&amp;<span class="keyword">mut</span> head, <span class="number">4</span>); <span class="comment">// 1 -&gt; 2 -&gt; 3 -&gt; 4</span></span><br><span class="line">    <span class="title function_ invoke__">show_list</span>(&amp;head);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Tip-for-x-in-y"><a href="#Tip-for-x-in-y" class="headerlink" title="Tip: for x in y"></a>Tip: <code>for x in y</code></h2><table>
<thead>
<tr>
<th><code>y</code> 类型</th>
<th>调用的迭代器</th>
<th><code>x</code> 的类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Vec&lt;T&gt;</code></td>
<td><code>.into_iter()</code></td>
<td><code>T</code></td>
<td>消耗集合，转移所有权</td>
</tr>
<tr>
<td><code>&amp;Vec&lt;T&gt;</code></td>
<td><code>.iter()</code></td>
<td><code>&amp;T</code></td>
<td>不可变引用迭代器，不消耗集合</td>
</tr>
<tr>
<td><code>&amp;mut Vec&lt;T&gt;</code></td>
<td><code>.iter_mut()</code></td>
<td><code>&amp;mut T</code></td>
<td>可变引用迭代器，允许修改集合</td>
</tr>
<tr>
<td><code>[T; N]</code></td>
<td><code>.iter()</code></td>
<td><code>&amp;T</code></td>
<td>固定数组转为切片的不可变引用</td>
</tr>
<tr>
<td><code>&amp;[T]</code></td>
<td><code>.iter()</code></td>
<td><code>&amp;T</code></td>
<td>切片的不可变引用</td>
</tr>
<tr>
<td><code>&amp;mut [T]</code></td>
<td><code>.iter_mut()</code></td>
<td><code>&amp;mut T</code></td>
<td>切片的可变引用</td>
</tr>
</tbody></table>
<p>通过这些规则，可以根据 <code>y</code> 的类型快速判断 <code>x</code> 的类型，以及是否发生所有权转移！</p>
<h2 id="Tip-let-Some-x-y"><a href="#Tip-let-Some-x-y" class="headerlink" title="Tip: let Some(x) = y"></a>Tip: <code>let Some(x) = y</code></h2><table>
<thead>
<tr>
<th>Y Type</th>
<th>X Type</th>
<th>equals</th>
<th>DEsc</th>
</tr>
</thead>
<tbody><tr>
<td><code>Option&lt;T&gt;</code></td>
<td><code>T</code></td>
<td><code>x = y.unwrap()</code></td>
<td>x 会取得数据的所有权</td>
</tr>
<tr>
<td><code>&amp;Option&lt;T&gt;</code></td>
<td><code>&amp;T</code></td>
<td><code>x = y.as_ref().unwrap()</code></td>
<td>x 只是读借用, 不会取得所有权</td>
</tr>
<tr>
<td><code>&amp;mut Option&lt;T&gt;</code></td>
<td><code>&amp;mut T</code></td>
<td><code>x = y.as_mut().unwrap()</code></td>
<td>x 是写借用, 不会取得所有权</td>
</tr>
</tbody></table>
<p>特别地</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当 y: Option&lt;T&gt;</span><br><span class="line">while let Some(x) = &amp;y =&gt; x: &amp;T</span><br><span class="line">if let Some(x) = &amp;mut y =&gt; x: &amp;mut T</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="peiyouyao"
      src="https://avatars.githubusercontent.com/u/126999663?v=4">
  <p class="site-author-name" itemprop="name">peiyouyao</p>
  <div class="site-description" itemprop="description">...</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/peiyouyao" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;peiyouyao" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:peiyou-yao@outlook.com" title="E-Mail → mailto:peiyou-yao@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peiyouyao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
